<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S2O - Tài khoản</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #e85d04;
        --primary-grad: linear-gradient(135deg, #ff9e66 0%, #e85d04 100%);
        --bg: #f8f9fa;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg);
        padding-bottom: 80px;
      }

      /* HEADER */
      .profile-header {
        background: var(--primary-grad);
        border-radius: 0 0 25px 25px;
        padding: 40px 20px 30px;
        color: white;
        text-align: center;
        position: relative;
        overflow: hidden;
      }
      .profile-header::after {
        content: "";
        position: absolute;
        top: -50px;
        right: -50px;
        width: 150px;
        height: 150px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
      }

      .avatar-wrapper {
        position: relative;
        width: 100px;
        height: 100px;
        margin: 0 auto 15px;
      }
      .profile-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.3);
        object-fit: cover;
        background: #ddd;
      }

      .user-name {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 2px;
        min-height: 1.8rem;
      }
      .user-email {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 10px;
        min-height: 1.2rem;
      }

      .rank-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: rgba(0, 0, 0, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        backdrop-filter: blur(5px);
        min-width: 100px;
        min-height: 25px;
      }

      /* STATS */
      .stats-box {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin: -25px 20px 20px;
        display: flex;
        justify-content: space-around;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        position: relative;
        z-index: 10;
      }
      .stat-item {
        text-align: center;
        flex: 1;
        border-right: 1px solid #eee;
      }
      .stat-item:last-child {
        border-right: none;
      }
      .stat-num {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary);
        display: block;
        min-height: 1.5rem;
      }
      .stat-label {
        font-size: 0.75rem;
        color: #888;
      }

      /* MENU */
      .menu-group {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        margin: 0 20px 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
      }
      .menu-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        text-decoration: none;
        color: #333;
        border-bottom: 1px solid #f5f5f5;
      }
      .menu-item:last-child {
        border-bottom: none;
      }
      .menu-icon {
        width: 35px;
        height: 35px;
        background: #fff5eb;
        color: var(--primary);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
      }
      .menu-text {
        flex: 1;
        font-weight: 500;
        font-size: 0.95rem;
      }
      .menu-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: #999;
        margin: 0 25px 10px;
        text-transform: uppercase;
      }

      /* LOGOUT */
      .logout-btn {
        margin: 0 20px 30px;
        background: #fff0f0;
        color: #dc3545;
        border: 1px solid #f8d7da;
        width: calc(100% - 40px);
        padding: 12px;
        border-radius: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      /* SKELETON LOADING */
      .skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        color: transparent !important;
        border-radius: 4px;
      }
      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* NAV */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 10px 0;
        border-top: 1px solid #eee;
        z-index: 1030;
      }
      .nav-link-custom {
        text-align: center;
        color: #999;
        text-decoration: none;
        flex: 1;
        display: block;
      }
      .nav-link-custom.active {
        color: var(--primary);
      }
      .nav-link-custom i {
        font-size: 1.4rem;
      }
      .nav-link-custom span {
        font-size: 0.7rem;
        display: block;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="profile-header">
      <div class="avatar-wrapper">
        <img
          id="userAvatar"
          src=""
          class="profile-avatar d-none"
          onerror="this.src='../img/anhbackup.jpg'"
        />
        <div id="avatarSkeleton" class="profile-avatar skeleton"></div>
      </div>
      <div id="userName" class="user-name skeleton w-50 mx-auto"></div>
      <div id="userEmail" class="user-email skeleton w-40 mx-auto"></div>
      <div id="userRank" class="rank-badge skeleton mx-auto"></div>
    </div>

    <div class="stats-box">
      <div class="stat-item">
        <span id="statOrders" class="stat-num skeleton w-50 mx-auto"></span>
        <span class="stat-label">Đơn hàng</span>
      </div>
      <div class="stat-item">
        <span id="statPoints" class="stat-num skeleton w-50 mx-auto"></span>
        <span class="stat-label">Điểm</span>
      </div>
      <div class="stat-item">
        <span id="statVouchers" class="stat-num skeleton w-50 mx-auto"></span>
        <span class="stat-label">Voucher</span>
      </div>
    </div>

    <div class="menu-title">Tài khoản</div>
    <div class="menu-group">
      <a href="#" class="menu-item"
        ><div class="menu-icon"><i class="bi bi-person"></i></div>
        <div class="menu-text">Hồ sơ cá nhân</div>
        <i class="bi bi-chevron-right text-muted"></i
      ></a>
      <a href="#" class="menu-item"
        ><div class="menu-icon"><i class="bi bi-geo-alt"></i></div>
        <div class="menu-text">Địa chỉ</div>
        <i class="bi bi-chevron-right text-muted"></i
      ></a>
      <a href="#" class="menu-item"
        ><div class="menu-icon"><i class="bi bi-wallet2"></i></div>
        <div class="menu-text">Ví & Voucher</div>
        <i class="bi bi-chevron-right text-muted"></i
      ></a>
    </div>

    <div class="menu-title">Cài đặt</div>
    <div class="menu-group">
      <div class="menu-item">
        <div class="menu-icon"><i class="bi bi-bell"></i></div>
        <div class="menu-text">Thông báo</div>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" checked />
        </div>
      </div>
      <a href="#" class="menu-item"
        ><div class="menu-icon"><i class="bi bi-shield-lock"></i></div>
        <div class="menu-text">Đổi mật khẩu</div>
        <i class="bi bi-chevron-right text-muted"></i
      ></a>
      <a href="#" class="menu-item"
        ><div class="menu-icon"><i class="bi bi-question-circle"></i></div>
        <div class="menu-text">Hỗ trợ</div>
        <i class="bi bi-chevron-right text-muted"></i
      ></a>
    </div>

    <button class="logout-btn" onclick="Auth.logout()">
      <i class="bi bi-box-arrow-right"></i> Đăng xuất
    </button>

    <div class="text-center mb-5 pb-3 small text-muted">Version 1.0.0</div>

    <nav class="bottom-nav">
      <div class="d-flex justify-content-around">
        <a href="restaurant-list.html" class="nav-link-custom"
          ><i class="bi bi-house"></i><span>Trang chủ</span></a
        >
        <a href="tracking.html" class="nav-link-custom"
          ><i class="bi bi-receipt"></i><span>Đơn hàng</span></a
        >
        <a href="profile.html" class="nav-link-custom active"
          ><i class="bi bi-person"></i><span>Tài khoản</span></a
        >
      </div>
    </nav>

    <script>
      // ============================================
      // 1. CONFIGURATION (Backend)
      // ============================================
      const API_CONFIG = {
        BASE_URL: "http://localhost:8080/api/v1",
        PROFILE_ENDPOINT: "/users/me",
      };

      const IMG_BACKUP = "../img/anhbackup.jpg";

      // ============================================
      // 2. AUTH SERVICE
      // ============================================
      const Auth = {
        getToken() {
          return localStorage.getItem("s2o_token");
        },

        logout() {
          if (confirm("Đăng xuất khỏi tài khoản?")) {
            localStorage.removeItem("s2o_token");
            window.location.href = "authcus.html";
          }
        },

        // API Call
        async fetchProfile() {
          const token = this.getToken();
          if (!token) return null; // No token -> null

          try {
            // CALL API THẬT
            /* const res = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.PROFILE_ENDPOINT}`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if(!res.ok) throw new Error(res.status);
            return await res.json();
            */

            // MOCK DATA (Xóa đoạn này khi có backend)
            return new Promise((resolve) =>
              setTimeout(
                () =>
                  resolve({
                    name: "Nguyễn Văn A",
                    email: "nguyenvana@gmail.com",
                    avatar: "",
                    rank: "Gold Member",
                    stats: { orders: 12, points: 350, vouchers: 2 },
                  }),
                1500
              )
            );
          } catch (error) {
            console.error("Auth Error:", error);
            if (error.message === "401") this.logout(); // Token hết hạn -> Logout
            return null;
          }
        },
      };

      // ============================================
      // 3. UI CONTROLLER
      // ============================================
      const UI = {
        async init() {
          // 1. Check Login
          if (!Auth.getToken()) {
            window.location.href = "authcus.html";
            return;
          }

          // 2. Load Data
          const user = await Auth.fetchProfile();

          if (user) {
            this.renderData(user);
          } else {
            alert("Phiên đăng nhập hết hạn!");
            Auth.logout();
          }
        },

        renderData(user) {
          // Ẩn Skeleton, Hiện Data
          this.removeSkeleton("userName", user.name);
          this.removeSkeleton("userEmail", user.email);

          // Rank
          const rankEl = document.getElementById("userRank");
          rankEl.classList.remove("skeleton");
          rankEl.innerHTML = `<i class="bi bi-award-fill text-warning"></i> ${user.rank}`;

          // Stats
          this.removeSkeleton("statOrders", user.stats.orders);
          this.removeSkeleton("statPoints", user.stats.points);
          this.removeSkeleton("statVouchers", user.stats.vouchers);

          // Avatar
          const imgEl = document.getElementById("userAvatar");
          const skelEl = document.getElementById("avatarSkeleton");
          imgEl.src = user.avatar || IMG_BACKUP;
          imgEl.classList.remove("d-none");
          skelEl.style.display = "none";
        },

        removeSkeleton(id, text) {
          const el = document.getElementById(id);
          el.classList.remove("skeleton", "w-50", "w-40", "mx-auto");
          el.textContent = text;
        },
      };

      // Start
      document.addEventListener("DOMContentLoaded", () => UI.init());
    </script>
  </body>
</html>
