<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S2O Food - Menu & ƒê√°nh gi√°</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/chatbot.css" />

  <style>
    :root {
      --primary: #e85d04;
      --dark: #1a1a1a;
      --gray: #6c757d;
      --light-bg: #f8f9fa;
      --radius: 12px;
    }
    body {
      font-family: "Inter", sans-serif;
      background: var(--light-bg);
      padding-bottom: 100px;
    }

    /* HEADER & NAV */
    .restaurant-header {
      position: relative;
      min-height: 320px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh ƒë·ªÉ ch·ª©a 2 n√∫t ƒë·∫πp h∆°n */
      background-color: var(--dark);
      color: white;
      display: flex;
      align-items: flex-end;
      padding-bottom: 20px;
    }
    .header-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      opacity: 0.6;
      mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0.3));
    }
    .header-content {
      position: relative;
      z-index: 2;
      width: 100%;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* 2 N√öT CH·ª®C NƒÇNG CH√çNH */
    .header-actions {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      flex-wrap: wrap;
    }
    .btn-header-primary {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 14px 25px;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(232, 93, 4, 0.4);
      flex: 1;
      min-width: 150px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-header-primary:hover {
      transform: translateY(-2px);
      background: #d94e00;
      color: white;
    }
    .btn-header-secondary {
      background: rgba(255, 255, 255, 0.95);
      color: var(--dark);
      border: none;
      border-radius: 50px;
      padding: 14px 25px;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 150px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-header-secondary:hover {
      transform: translateY(-2px);
      background: white;
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: 0.2s;
    }

    .sticky-nav {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      padding: 10px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .nav-scroll {
      display: flex;
      overflow-x: auto;
      padding: 0 15px;
      gap: 10px;
      scrollbar-width: none;
    }
    .nav-scroll::-webkit-scrollbar { display: none; }

    .cat-btn {
      border: 1px solid #eee;
      background: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      color: var(--gray);
      white-space: nowrap;
      transition: 0.2s;
    }
    .cat-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* MENU ITEMS */
    .menu-section {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px 15px;
    }
    .cat-title {
      font-weight: 800;
      font-size: 1.2rem;
      margin: 20px 0 15px;
      color: var(--dark);
      border-left: 4px solid var(--primary);
      padding-left: 10px;
    }
    .item-card {
      background: white;
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
      cursor: pointer;
      transition: 0.2s;
      align-items: flex-start;
      min-height: 130px;
    }
    .item-img {
      width: 110px;
      height: 110px;
      border-radius: var(--radius);
      object-fit: cover;
      flex-shrink: 0;
      background: #eee;
    }
    .item-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 110px;
    }
    .item-name { font-weight: 700; color: var(--dark); margin-bottom: 4px; }
    .item-price { color: var(--primary); font-weight: 700; font-size: 1.1rem; margin-top: auto; }
    .item-add-btn { display: flex; align-items: flex-end; color: var(--primary); padding-bottom: 5px; }

    /* MODAL & REVIEWS */
    .modal-content { border: none; border-radius: 20px; overflow: hidden; }
    .modal-img-wrapper { position: relative; height: 280px; background: #eee; }
    .modal-img { width: 100%; height: 100%; object-fit: cover; }
    .modal-close-btn {
      position: absolute; top: 15px; right: 15px;
      background: rgba(0, 0, 0, 0.3); border: none; color: white;
      width: 35px; height: 35px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
    }

    .review-card { border-bottom: 1px solid #eee; padding: 15px 0; }
    .review-avatar {
      width: 40px; height: 40px; background: #e9ecef; color: #555;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-weight: bold; margin-right: 10px;
    }
    .star-rating i { font-size: 1.5rem; color: #dee2e6; cursor: pointer; transition: 0.2s; margin-right: 5px; }
    .star-rating i.active { color: #ffc107; }

    /* CART & OFFCANVAS */
    .cart-bar {
      position: fixed; bottom: 20px; left: 50%;
      transform: translateX(-50%) translateY(150%);
      width: 90%; max-width: 600px;
      background: var(--dark); color: white;
      padding: 15px 25px; border-radius: 50px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      z-index: 990; transition: 0.4s;
    }
    .cart-bar.show { transform: translateX(-50%) translateY(0); }
    .offcanvas-bottom { height: 85vh !important; border-top-left-radius: 20px; border-top-right-radius: 20px; }
    .cart-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; }
    .cart-item-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; margin-right: 10px; }

    .qty-mini-control {
      display: flex; align-items: center; background: #f1f1f1;
      border-radius: 20px; padding: 2px 8px;
    }
    .qty-mini-btn { border: none; background: none; color: var(--primary); font-weight: bold; width: 25px; }

    /* UTILS */
    .loading { text-align: center; padding: 50px; color: var(--gray); }
    .btn-add-cart {
      background: var(--primary); color: white; border: none;
      padding: 12px 30px; border-radius: 30px; font-weight: 700; flex: 1; margin-left: 15px;
    }
    .qty-control {
      display: flex; align-items: center; gap: 15px;
      background: #f1f1f1; border-radius: 30px; padding: 5px 15px;
    }
    .qty-btn { border: none; background: none; font-size: 1.5rem; color: var(--primary); }

    .cart-summary-alert {
      background: #e7f5ff; border-left: 4px solid #0d6efd;
      padding: 12px; border-radius: 8px; margin-bottom: 15px;
    }

    /* TABLE BANNER */
    .table-banner {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1050;
      background-color: #d1e7dd; color: #0f5132;
      text-align: center; padding: 10px; font-weight: bold;
      border-bottom: 2px solid #badbcc; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<header class="restaurant-header">
  <div id="headerBg" class="header-bg"></div>
  <button class="back-btn" onclick="window.location.href = 'restaurant-list.html'">
    <i class="fas fa-arrow-left"></i>
  </button>
  <div class="header-content container">
    <h1 id="resName" class="mb-1">ƒêang t·∫£i...</h1>
    <div class="d-flex align-items-center gap-3 font-sm mb-3">
      <span><i class="fas fa-star text-warning"></i> <span id="resRating">--</span></span>
      <span><i class="fas fa-clock"></i> <span id="resTime">--</span></span>
      <span><i class="fas fa-map-marker-alt"></i> <span id="resAddr">--</span></span>
    </div>

    <div class="header-actions">
      <button class="btn-header-primary" onclick="openBookingModal()">
        <i class="fas fa-calendar-check me-2"></i> ƒê·∫∑t b√†n gi·ªØ ch·ªó
      </button>
      <button class="btn-header-secondary" onclick="scrollToMenu()">
        <i class="fas fa-shopping-bag me-2"></i> ƒê·∫∑t ƒë∆°n mang v·ªÅ
      </button>
    </div>
  </div>
</header>

<div class="sticky-nav" id="stickyNav">
  <div class="nav-scroll" id="catNav"></div>
</div>

<main id="menuContainer" class="menu-section">
  <div class="loading">
    <div class="spinner-border text-warning"></div>
    <br />ƒêang t·∫£i th·ª±c ƒë∆°n...
  </div>
</main>

<div id="cartBar" class="cart-bar">
  <div>
    <div class="small opacity-75">T·ªïng c·ªông</div>
    <div class="fw-bold fs-5" id="floatTotal">0ƒë</div>
  </div>
  <div class="d-flex align-items-center gap-3">
    <span class="badge bg-danger rounded-pill" id="floatCount">0</span>
    <button class="btn btn-light rounded-pill fw-bold text-dark px-3 py-1"
            data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
      Xem gi·ªè
    </button>
  </div>
</div>

<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-img-wrapper">
        <img id="modalImg" src="" class="modal-img" />
        <button type="button" class="modal-close-btn" data-bs-dismiss="modal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body p-4">
        <h2 id="modalName" class="fw-bold mb-1">T√™n m√≥n</h2>
        <div id="modalPrice" class="text-primary fw-bold fs-4 mb-3">0ƒë</div>

        <ul class="nav nav-tabs mb-3">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info-tab">Th√¥ng tin</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#review-tab">ƒê√°nh gi√°</button></li>
        </ul>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="info-tab">
            <p id="modalDesc" class="text-muted">M√¥ t·∫£ m√≥n ƒÉn...</p>
          </div>
          <div class="tab-pane fade" id="review-tab">
            <div id="reviewsList" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
              <div class="text-center text-muted py-3">ƒêang t·∫£i ƒë√°nh gi√°...</div>
            </div>
            <div class="mt-3 pt-3 border-top bg-light p-3 rounded">
              <h6 class="fw-bold mb-2">Vi·∫øt ƒë√°nh gi√°</h6>
              <div class="star-rating mb-2" id="starSelect">
                <i class="fas fa-star active" onclick="setRating(1)"></i>
                <i class="fas fa-star active" onclick="setRating(2)"></i>
                <i class="fas fa-star active" onclick="setRating(3)"></i>
                <i class="fas fa-star active" onclick="setRating(4)"></i>
                <i class="fas fa-star active" onclick="setRating(5)"></i>
                <span class="ms-2 text-warning fw-bold" id="ratingText">5.0 Tuy·ªát v·ªùi</span>
              </div>
              <textarea id="reviewInput" class="form-control mb-2" rows="2" placeholder="Chia s·∫ª c·∫£m nh·∫≠n..."></textarea>
              <div class="d-flex justify-content-end">
                <button class="btn btn-primary btn-sm px-4 rounded-pill" onclick="submitReview()">G·ª≠i ƒë√°nh gi√°</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center bg-white border-top p-3">
        <div class="qty-control">
          <button class="qty-btn" onclick="updateModalQty(-1)">-</button>
          <span id="modalQty" class="qty-val">1</span>
          <button class="qty-btn" onclick="updateModalQty(1)">+</button>
        </div>
        <button class="btn-add-cart" onclick="addToCartFromModal()">
          Th√™m - <span id="modalBtnPrice">0ƒë</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="offcanvas offcanvas-bottom" tabindex="-1" id="cartOffcanvas">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-bold">Gi·ªè h√†ng c·ªßa b·∫°n</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div id="cartListItems"></div>
    <div class="mb-3">
      <label class="form-label small fw-bold"><i class="fas fa-comment-dots me-1"></i> Ghi ch√∫ cho qu√°n</label>
      <textarea id="orderNote" class="form-control" rows="2" placeholder="VD: √çt cay, kh√¥ng h√†nh..."></textarea>
    </div>
    <div class="bg-light p-3 rounded mt-3">
      <div class="input-group mb-2">
        <input type="text" id="voucherCode" class="form-control" placeholder="M√£ gi·∫£m gi√°" />
        <button class="btn btn-dark" onclick="applyVoucher()">√Åp d·ª•ng</button>
      </div>
      <div id="voucherMsg" class="small ms-1"></div>
    </div>
    <div class="p-3 border-top mt-3">
      <div class="d-flex justify-content-between mb-2"><span>T·∫°m t√≠nh</span><span id="cartSubtotal">0ƒë</span></div>
      <div class="d-flex justify-content-between mb-2 text-success"><span>Gi·∫£m gi√°</span><span id="cartDiscount">0ƒë</span></div>
      <div class="d-flex justify-content-between fw-bold fs-5 pt-2 border-top"><span>T·ªïng thanh to√°n</span><span id="cartFinalTotal" class="text-primary">0ƒë</span></div>
      <div class="d-grid gap-2 mt-3">
        <button class="btn btn-primary py-3 rounded-pill fw-bold" onclick="openCheckoutModal()">
          <i class="fas fa-check-circle"></i> TI·∫æN H√ÄNH ƒê·∫∂T H√ÄNG
        </button>
        <button class="btn btn-outline-primary py-2 rounded-pill fw-bold" onclick="openBookingWithCart()">
          <i class="fas fa-calendar-alt"></i> ƒê·∫∂T B√ÄN K√àM M√ìN N√ÄY
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">ƒê·∫∑t b√†n gi·ªØ ch·ªó</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-2">
        <div id="cartSummaryAlert" class="cart-summary-alert d-none">
          <i class="fas fa-shopping-basket me-2"></i>
          <strong>B·∫°n ƒëang ƒë·∫∑t b√†n k√®m <span id="cartItemCount">0</span> m√≥n ƒÉn</strong>
        </div>

        <p class="text-muted small mb-4">
          G·ª≠i y√™u c·∫ßu ƒë·∫∑t b√†n. Nh√¢n vi√™n s·∫Ω li√™n h·ªá x√°c nh·∫≠n v√† x·∫øp b√†n cho b·∫°n.
        </p>

        <form id="bookingForm">
          <div class="mb-3">
            <label class="form-label small fw-bold text-secondary">H·ªç v√† t√™n</label>
            <div class="input-group">
              <span class="input-group-text bg-light border-0"><i class="fas fa-user text-muted"></i></span>
              <input type="text" id="bookName" class="form-control bg-light border-0" required placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold text-secondary">S·ªë ƒëi·ªán tho·∫°i</label>
            <div class="input-group">
              <span class="input-group-text bg-light border-0"><i class="fas fa-phone text-muted"></i></span>
              <input type="tel" id="bookPhone" class="form-control bg-light border-0" required placeholder="09xxxxxxx" />
            </div>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label small fw-bold text-secondary">Ng√†y ƒë·∫øn</label>
              <input type="date" id="bookDate" class="form-control bg-light border-0" required />
            </div>
            <div class="col-6">
              <label class="form-label small fw-bold text-secondary">Gi·ªù ƒë·∫øn</label>
              <input type="time" id="bookTime" class="form-control bg-light border-0" required />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold text-secondary">S·ªë l∆∞·ª£ng kh√°ch</label>
            <div class="d-flex align-items-center bg-light rounded px-3 py-2">
              <i class="fas fa-users text-muted me-3"></i>
              <input type="range" id="bookGuestsRange" class="form-range flex-grow-1 me-3" min="1" max="20" value="2"
                     oninput="document.getElementById('guestCountDisplay').innerText = this.value" />
              <span id="guestCountDisplay" class="fw-bold text-primary fs-5">2</span>
            </div>
          </div>
          <div class="mb-4">
            <label class="form-label small fw-bold text-secondary">Ghi ch√∫</label>
            <textarea id="bookNote" class="form-control bg-light border-0" rows="2" placeholder="VD: C·∫ßn gh·∫ø tr·∫ª em, ph√≤ng l·∫°nh..."></textarea>
          </div>
          <button type="submit" class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-sm">
            <i class="fas fa-paper-plane me-2"></i> G·ª≠i y√™u c·∫ßu ƒë·∫∑t b√†n
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="checkoutModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold">X√°c nh·∫≠n ƒë·∫∑t h√†ng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-center mb-3">B·∫°n mu·ªën d√πng b·ªØa th·∫ø n√†o?</p>
        <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="pills-dinein-tab" data-bs-toggle="pill" data-bs-target="#pills-dinein" type="button" onclick="setOrderType('DINE_IN')">
              <i class="fas fa-utensils me-2"></i>T·∫°i B√†n
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="pills-delivery-tab" data-bs-toggle="pill" data-bs-target="#pills-delivery" type="button" onclick="setOrderType('DELIVERY')">
              <i class="fas fa-motorcycle me-2"></i>Giao H√†ng
            </button>
          </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
          <div class="tab-pane fade show active" id="pills-dinein">
            <div class="mb-3">
              <label class="form-label small text-muted">S·ªë b√†n (N·∫øu ƒëang ng·ªìi t·∫°i qu√°n)</label>
              <input type="number" id="checkout-table" class="form-control text-center fs-5 fw-bold" placeholder="VD: 5" />
              <div class="form-text">N·∫øu ch∆∞a c√≥ b√†n, nh√¢n vi√™n s·∫Ω x·∫øp b√†n cho b·∫°n.</div>
            </div>
          </div>
          <div class="tab-pane fade" id="pills-delivery">
            <div class="mb-3">
              <label class="form-label small text-muted">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng (*)</label>
              <input type="text" id="checkout-address" class="form-control" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng..." />
            </div>
            <div class="mb-3">
              <label class="form-label small text-muted">S·ªë ƒëi·ªán tho·∫°i (*)</label>
              <input type="text" id="checkout-phone" class="form-control" placeholder="09xxxxxxxx" />
            </div>
            <div class="mb-3">
              <label class="form-label small text-muted">H·∫πn gi·ªù (T√πy ch·ªçn)</label>
              <input type="datetime-local" id="checkout-time" class="form-control" />
            </div>
          </div>
        </div>

        <div id="loyalty-section" class="mb-3 p-3 bg-light rounded d-none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small fw-bold text-primary"><i class="fas fa-crown"></i> ƒêi·ªÉm c·ªßa b·∫°n: <span id="user-points-display">0</span></span>
            <small class="text-muted">(1 ƒëi·ªÉm = 1.000ƒë)</small>
          </div>
          <div class="input-group input-group-sm">
            <span class="input-group-text">D√πng</span>
            <input type="number" id="points-to-use" class="form-control" placeholder="0" min="0" oninput="updateCheckoutTotal()">
            <span class="input-group-text">ƒëi·ªÉm</span>
          </div>
          <div id="point-error" class="text-danger small mt-1"></div>
        </div>

        <div class="alert alert-warning small mt-3">
          <div class="d-flex justify-content-between"><span>T·∫°m t√≠nh:</span> <span id="checkout-subtotal">0ƒë</span></div>
          <div class="d-flex justify-content-between text-success"><span>Gi·∫£m gi√° ƒëi·ªÉm:</span> <span id="checkout-discount">-0ƒë</span></div>
          <hr class="my-1">
          <div class="d-flex justify-content-between fw-bold fs-5"><span>THANH TO√ÅN:</span><strong id="modal-final-total" class="text-danger">0ƒë</strong></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button type="button" class="btn btn-primary fw-bold w-100" onclick="submitOrder()">HO√ÄN T·∫§T ƒê·∫∂T H√ÄNG</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
<script src="../js/chatbot.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // === 1. CONFIG & PARAMS ===
  const urlParams = new URLSearchParams(window.location.search);
  const REST_ID = urlParams.get("id");
  const TABLE_PARAM = urlParams.get("table");
  const TABLE_NUM = TABLE_PARAM ? parseInt(TABLE_PARAM) : 0;
  const IS_GUEST_MODE = TABLE_NUM > 0;

  const CART_KEY = `s2o_cart_${REST_ID}`;
  const IMG_BACKUP = "../img/anhbackup.jpg";
  const VOUCHERS = { SAVE10: 0.1, FREESHIP: 15000 };

  let bookingWithCart = false;
  let currentOrderType = "DINE_IN";
  let appliedVoucher = null;
  let currentUserPoints = 0;
  let cart = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
  let currentItem = null;
  let modalQty = 1;
  let userRating = 5;

  // === 2. USER AUTH CHECK ===
  let CURRENT_USER = null;
  const userStr = localStorage.getItem("user");
  if (userStr) {
    try {
      const u = JSON.parse(userStr);
      let avatarChar = "U";
      let fullName = u.fullName || u.username || "User";
      if (fullName) {
        const parts = fullName.trim().split(" ");
        if (parts.length > 0) avatarChar = parts[parts.length - 1].charAt(0).toUpperCase();
      }
      CURRENT_USER = { id: u.id, name: fullName, avatar: avatarChar };
    } catch (e) {
      console.error("Parse user error:", e);
      localStorage.removeItem("user");
    }
  }

  // === 3. INIT ===
  async function init() {
    if (!REST_ID) return alert("L·ªói: Thi·∫øu ID nh√† h√†ng");

    if (IS_GUEST_MODE) {
      showTableBanner(TABLE_NUM);
      // 1. ·∫®n c·ª•m n√∫t "ƒê·∫∑t b√†n" & "Mang v·ªÅ" v√¨ kh√°ch ƒëang ng·ªìi t·∫°i qu√°n r·ªìi
      const actionBtns = document.querySelector(".header-actions");
      if (actionBtns) actionBtns.style.display = 'none';

      localStorage.setItem("currentTable", TABLE_NUM);
      localStorage.setItem("currentRestaurant", REST_ID);
    }
    renderCartOffcanvas();

    try {
      // Fetch Restaurant Info
      const resRest = await fetch(`http://localhost:8080/api/guest/restaurants`);
      const restaurants = await resRest.json();
      const info = restaurants.find((r) => r.id == REST_ID);
      if (info) {
        document.getElementById("resName").textContent = info.name;
        document.getElementById("resAddr").textContent = info.address;
        document.getElementById("resTime").textContent = info.time || "ƒêang c·∫≠p nh·∫≠t";
        document.getElementById("resRating").textContent = info.rating;
        const bg = new Image();
        bg.src = info.image;
        bg.onload = () => (document.getElementById("headerBg").style.backgroundImage = `url('${info.image}')`);
        bg.onerror = () => (document.getElementById("headerBg").style.backgroundImage = `url('${IMG_BACKUP}')`);
      }

      // Fetch Menu
      const resMenu = await fetch(`http://localhost:8080/api/guest/menu/restaurant/${REST_ID}`);
      const flatItems = await resMenu.json();
      if (flatItems && flatItems.length > 0) {
        renderMenu(groupItemsByCategory(flatItems));
      } else {
        document.getElementById("menuContainer").innerHTML = '<div class="text-center mt-5 text-muted"><i class="fas fa-utensils fa-3x mb-3"></i><br>Ch∆∞a c√≥ m√≥n ƒÉn n√†o</div>';
      }
    } catch (e) {
      console.error(e);
      document.getElementById("menuContainer").innerHTML = `<div class="alert alert-danger text-center">Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Server!</div>`;
    }
  }

  // === UTILS ===
  function scrollToMenu() {
    document.getElementById("stickyNav").scrollIntoView({ behavior: "smooth" });
  }

  function showTableBanner(num) {
    const banner = document.createElement('div');
    banner.className = 'table-banner';
    banner.innerHTML = `<i class="fas fa-map-marker-alt me-2"></i> B·∫°n ƒëang ng·ªìi t·∫°i <strong>B√†n s·ªë ${num}</strong>`;
    document.body.prepend(banner);
    document.body.style.paddingTop = '50px';
  }

  function groupItemsByCategory(items) {
    const groups = {};
    items.forEach((item) => {
      const catName = item.category || "M√≥n Kh√°c";
      if (!groups[catName]) groups[catName] = [];
      groups[catName].push(item);
    });
    return Object.keys(groups).map((key) => ({ category: key, items: groups[key] }));
  }

  function renderMenu(categories) {
    const nav = document.getElementById("catNav");
    const container = document.getElementById("menuContainer");
    nav.innerHTML = "";
    container.innerHTML = "";

    categories.forEach((cat, idx) => {
      const btn = document.createElement("button");
      btn.className = `cat-btn ${idx === 0 ? "active" : ""}`;
      btn.textContent = cat.category;
      btn.onclick = () => {
        document.querySelectorAll(".cat-btn").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(`cat-${idx}`).scrollIntoView({ behavior: "smooth", block: "start" });
      };
      nav.appendChild(btn);

      let html = `<div id="cat-${idx}"><div class="cat-title">${cat.category}</div>`;
      cat.items.forEach((item) => {
        html += `
          <div class="item-card" onclick='openModal(${JSON.stringify(item)})'>
            <img src="${item.imageUrl || item.image || IMG_BACKUP}" class="item-img" onerror="this.src='${IMG_BACKUP}'">
            <div class="item-info">
              <div><div class="item-name">${item.name}</div><div class="small text-muted">${item.description || ""}</div></div>
              <div class="item-price">${item.price.toLocaleString()}ƒë</div>
            </div>
            <div class="item-add-btn"><i class="fas fa-plus-circle fa-2x"></i></div>
          </div>`;
      });
      html += `</div>`;
      container.innerHTML += html;
    });
  }

  // === MODAL DETAIL LOGIC ===
  function openModal(item) {
    currentItem = item;
    modalQty = 1;
    setRating(5);
    document.getElementById("modalName").textContent = item.name;
    document.getElementById("modalPrice").textContent = item.price.toLocaleString() + "ƒë";
    document.getElementById("modalDesc").textContent = item.description || "M√≥n ngon m·ªói ng√†y.";
    document.getElementById("modalImg").src = item.imageUrl || item.image || IMG_BACKUP;
    document.getElementById("modalQty").textContent = 1;
    document.getElementById("modalBtnPrice").textContent = item.price.toLocaleString() + "ƒë";
    loadFakeReviews();
    bootstrap.Modal.getOrCreateInstance(document.getElementById("itemModal")).show();
  }

  function updateModalQty(change) {
    if (modalQty + change > 0) {
      modalQty += change;
      document.getElementById("modalQty").textContent = modalQty;
      document.getElementById("modalBtnPrice").textContent = (currentItem.price * modalQty).toLocaleString() + "ƒë";
    }
  }

  function addToCartFromModal() {
    const exist = cart.find((i) => i.id === currentItem.id);
    if (exist) exist.qty += modalQty;
    else cart.push({ ...currentItem, qty: modalQty });
    saveCart();
    bootstrap.Modal.getOrCreateInstance(document.getElementById("itemModal")).hide();
    bootstrap.Offcanvas.getOrCreateInstance(document.getElementById("cartOffcanvas")).show();
  }

  // === REVIEW LOGIC ===
  function setRating(n) {
    userRating = n;
    const labels = ["T·ªá", "K√©m", "B√¨nh th∆∞·ªùng", "T·ªët", "Tuy·ªát v·ªùi"];
    document.getElementById("ratingText").textContent = `${n}.0 ${labels[n - 1]}`;
    document.querySelectorAll("#starSelect i").forEach((star, index) => {
      if (index < n) star.classList.add("active"); else star.classList.remove("active");
    });
  }

  async function loadFakeReviews() {
    const list = document.getElementById("reviewsList");
    list.innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div> ƒêang t·∫£i...</div>';
    try {
      const res = await fetch(`http://localhost:8080/api/reviews/${currentItem.id}`);
      if (!res.ok) throw new Error();
      const reviews = await res.json();
      if (!reviews || reviews.length === 0) {
        list.innerHTML = '<div class="text-center text-muted py-3">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</div>';
      } else {
        let html = "";
        reviews.forEach((r) => {
          html += `
            <div class="review-card">
              <div class="d-flex justify-content-between mb-1">
                <div class="d-flex align-items-center">
                  <div class="review-avatar">${r.avatar}</div>
                  <div><div class="fw-bold font-sm">${r.user}</div><div class="star-display">${"‚òÖ".repeat(r.rate)}${"‚òÜ".repeat(5 - r.rate)}</div></div>
                </div>
                <div class="small text-muted">${r.date}</div>
              </div>
              <p class="mb-0 small text-muted ps-5">${r.comment}</p>
            </div>`;
        });
        list.innerHTML = html;
      }
    } catch (err) {
      list.innerHTML = '<div class="text-center text-danger py-3">Kh√¥ng th·ªÉ t·∫£i ƒë√°nh gi√°.</div>';
    }
  }

  async function submitReview() {
    if (!CURRENT_USER) {
      if (confirm("C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°. ƒêƒÉng nh·∫≠p ngay?")) {
        localStorage.setItem("redirect_after_login", window.location.href);
        window.location.href = "authcus.html";
      }
      return;
    }
    const text = document.getElementById("reviewInput").value;
    if (!text.trim()) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");
    try {
      await fetch(`http://localhost:8080/api/reviews/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: CURRENT_USER.id, itemId: currentItem.id, rating: userRating, comment: text }),
      });
      alert("ƒê√£ g·ª≠i ƒë√°nh gi√°!");
      document.getElementById("reviewInput").value = "";
      loadFakeReviews();
    } catch (err) { alert("L·ªói server!"); }
  }

  // === CART LOGIC ===
  function renderCartOffcanvas() {
    const list = document.getElementById("cartListItems");
    let subtotal = 0;
    if (cart.length === 0) {
      list.innerHTML = '<div class="text-center p-4 text-muted"><i class="fas fa-shopping-basket fa-3x mb-3"></i><br>Gi·ªè h√†ng tr·ªëng</div>';
      document.getElementById("cartBar").classList.remove("show");
    } else {
      let html = "";
      cart.forEach((item, idx) => {
        subtotal += item.price * item.qty;
        html += `
          <div class="cart-item">
            <div class="d-flex align-items-center">
              <img src="${item.imageUrl || item.image || IMG_BACKUP}" class="cart-item-img" onerror="this.src='${IMG_BACKUP}'">
              <div><div class="fw-bold">${item.name}</div><div class="text-primary fw-bold">${item.price.toLocaleString()}ƒë</div></div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <div class="qty-mini-control">
                <button class="qty-mini-btn" onclick="updateCartItem(${idx}, -1)">-</button><span>${item.qty}</span><button class="qty-mini-btn" onclick="updateCartItem(${idx}, 1)">+</button>
              </div>
              <button class="btn btn-sm text-danger" onclick="removeCartItem(${idx})"><i class="fas fa-trash"></i></button>
            </div>
          </div>`;
      });
      list.innerHTML = html;
      document.getElementById("cartBar").classList.add("show");
      document.getElementById("floatCount").textContent = cart.reduce((s, i) => s + i.qty, 0);
      document.getElementById("floatTotal").textContent = subtotal.toLocaleString() + "ƒë";
    }
    let discount = 0;
    if (appliedVoucher) discount = appliedVoucher.type === "percent" ? subtotal * appliedVoucher.val : appliedVoucher.val;
    if (discount > subtotal) discount = subtotal;
    document.getElementById("cartSubtotal").textContent = subtotal.toLocaleString() + "ƒë";
    document.getElementById("cartDiscount").textContent = "-" + discount.toLocaleString() + "ƒë";
    document.getElementById("cartFinalTotal").textContent = (subtotal - discount).toLocaleString() + "ƒë";
  }

  function updateCartItem(idx, change) {
    cart[idx].qty += change;
    if (cart[idx].qty <= 0) cart.splice(idx, 1);
    saveCart();
  }
  function removeCartItem(idx) { cart.splice(idx, 1); saveCart(); }
  function saveCart() { localStorage.setItem(CART_KEY, JSON.stringify(cart)); renderCartOffcanvas(); }

  function applyVoucher() {
    const code = document.getElementById("voucherCode").value.trim().toUpperCase();
    if (VOUCHERS[code]) {
      const val = VOUCHERS[code];
      appliedVoucher = { code, val, type: val < 1 ? "percent" : "fixed" };
      document.getElementById("voucherMsg").textContent = `ƒê√£ √°p d·ª•ng: ${code}`;
      document.getElementById("voucherMsg").className = "small text-success";
    } else {
      appliedVoucher = null;
      document.getElementById("voucherMsg").textContent = "M√£ kh√¥ng h·ª£p l·ªá";
      document.getElementById("voucherMsg").className = "small text-danger";
    }
    renderCartOffcanvas();
  }

  // === CHECKOUT LOGIC ===
  function updateCheckoutTotal() {
    const rawSubtotal = document.getElementById("cartFinalTotal").innerText;
    const subtotal = parseFloat(rawSubtotal.replace(/\./g, "").replace("ƒë", ""));
    let points = parseInt(document.getElementById("points-to-use").value) || 0;
    if (points > currentUserPoints) {
      document.getElementById("point-error").innerText = "V∆∞·ª£t qu√° ƒëi·ªÉm hi·ªán c√≥!";
      points = currentUserPoints;
      document.getElementById("points-to-use").value = points;
    } else {
      document.getElementById("point-error").innerText = "";
    }
    const discount = points * 1000;
    let final = subtotal - discount;
    if (final < 0) final = 0;
    document.getElementById("checkout-subtotal").innerText = subtotal.toLocaleString() + "ƒë";
    document.getElementById("checkout-discount").innerText = "-" + discount.toLocaleString() + "ƒë";
    document.getElementById("modal-final-total").innerText = final.toLocaleString() + "ƒë";
  }

  function setOrderType(type) { currentOrderType = type; }

  async function openCheckoutModal() {
    if (cart.length === 0) return alert("Gi·ªè h√†ng tr·ªëng!");
    if (!IS_GUEST_MODE && (!localStorage.getItem("token") || !CURRENT_USER)) {
      localStorage.setItem("redirect_after_login", window.location.href);
      if (confirm("ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng?")) window.location.href = "authcus.html";
      return;
    }

    if (IS_GUEST_MODE) {
      const tableInput = document.getElementById("checkout-table");
      if (tableInput) { tableInput.value = TABLE_NUM; tableInput.disabled = true; }
      const dineInTab = document.getElementById("pills-dinein-tab");
      if (dineInTab) new bootstrap.Tab(dineInTab).show();
      setOrderType("DINE_IN");
      const deliveryTab = document.getElementById("pills-delivery-tab");
      if (deliveryTab) deliveryTab.style.display = 'none';
    }

    const cartTotalEl = document.getElementById("cartFinalTotal");
    const modalTotalEl = document.getElementById("modal-final-total");
    if (cartTotalEl && modalTotalEl) modalTotalEl.innerText = cartTotalEl.innerText;

    // LOYALTY SECTION
    const loyaltySec = document.getElementById("loyalty-section");
    if (loyaltySec) {
      if (!IS_GUEST_MODE && CURRENT_USER) {
        loyaltySec.classList.remove("d-none");
        try {
          const res = await fetch(`http://localhost:8080/api/users/me`, {
            headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
          });
          if (res.ok) {
            const u = await res.json();
            currentUserPoints = u.points || 0;
            localStorage.setItem("user", JSON.stringify(u));
          }
        } catch (e) { currentUserPoints = 0; }

        const disp = document.getElementById("user-points-display");
        const inp = document.getElementById("points-to-use");
        if (disp) disp.innerText = currentUserPoints;
        if (inp) { inp.max = currentUserPoints; inp.value = ""; }
      } else {
        loyaltySec.classList.add("d-none");
      }
    }
    updateCheckoutTotal();
    bootstrap.Modal.getOrCreateInstance(document.getElementById("checkoutModal")).show();
  }

  async function submitOrder() {
    const points = parseInt(document.getElementById("points-to-use").value) || 0;
    const rawTotal = document.getElementById("cartFinalTotal").textContent;
    const totalAmount = parseFloat(rawTotal.replace(/\./g, "").replace("ƒë", ""));
    const note = document.getElementById("orderNote") ? document.getElementById("orderNote").value : "";

    const payload = {
      restaurantId: REST_ID,
      restaurantName: document.getElementById("resName").textContent,
      total: totalAmount,
      note: note,
      items: cart.map((i) => ({ name: i.name, qty: i.qty, price: i.price })),
      pointsToUse: points,
      orderType: currentOrderType,
      userId: CURRENT_USER ? CURRENT_USER.id : null
    };

    if (currentOrderType === "DINE_IN") {
      const table = document.getElementById("checkout-table").value;
      payload.tableNumber = table ? parseInt(table) : 0;
      payload.address = table ? `B√†n ${table}` : "T·∫°i qu√°n (Ch·ªù x·∫øp b√†n)";
    } else {
      const addr = document.getElementById("checkout-address").value;
      const phone = document.getElementById("checkout-phone").value;
      if (!addr || !phone) return alert("Thi·∫øu ƒë·ªãa ch·ªâ/SƒêT nh·∫≠n h√†ng!");
      payload.deliveryAddress = addr;
      payload.customerPhone = phone;
      payload.address = `Giao t·ªõi: ${addr}`;
      payload.desiredTime = document.getElementById("checkout-time").value || null;
      payload.tableNumber = 0;
    }

    const btn = document.querySelector('#checkoutModal button[onclick="submitOrder()"]');
    const oldText = btn.innerText;
    btn.innerText = "ƒêang x·ª≠ l√Ω...";
    btn.disabled = true;

    try {
      let url = IS_GUEST_MODE ? `http://localhost:8080/api/guest/orders/create` : `http://localhost:8080/api/orders/create`;
      let headers = { "Content-Type": "application/json" };
      if (!IS_GUEST_MODE) headers["Authorization"] = `Bearer ${localStorage.getItem("token")}`;

      const res = await fetch(url, { method: "POST", headers: headers, body: JSON.stringify(payload) });
      const result = await res.json();

      if (res.ok) {
        if (CURRENT_USER && points > 0) {
          const u = JSON.parse(localStorage.getItem("user"));
          if (u) { u.points = (u.points || 0) - points; localStorage.setItem("user", JSON.stringify(u)); }
        }
        alert("üéâ ƒê·∫∑t m√≥n th√†nh c√¥ng!");
        cart = []; saveCart();
        if (IS_GUEST_MODE && result.orderId) localStorage.setItem("currentGuestOrderId", result.orderId);
        window.location.href = IS_GUEST_MODE ? "tracking.html?mode=guest" : "tracking.html";
      } else {
        alert("L·ªói: " + (result.message || "ƒê·∫∑t h√†ng th·∫•t b·∫°i"));
      }
    } catch (e) {
      alert("L·ªói k·∫øt n·ªëi: " + e.message);
    } finally {
      btn.innerText = oldText;
      btn.disabled = false;
    }
  }

  // === BOOKING LOGIC (NO TABLE SELECTION) ===
  function openBookingModal(withCart = false) {
    if (!CURRENT_USER) {
      if (confirm("ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t b√†n?")) {
        localStorage.setItem("redirect_after_login", window.location.href);
        window.location.href = "authcus.html";
      }
      return;
    }
    bookingWithCart = withCart;
// Th√™m v√†o trong h√†m openBookingModal() trong menu.html
    function openBookingModal(withCart = false) {
      // ... code c≈© ...

      // --- LOGIC GI·ªöI H·∫†N NG√ÄY ---
      const dateInput = document.getElementById("bookDate");
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      // Format YYYY-MM-DD
      const formatDate = (date) => date.toISOString().split("T")[0];

      dateInput.min = formatDate(today);      // Kh√¥ng cho ch·ªçn qu√° kh·ª©
      dateInput.max = formatDate(tomorrow);   // Ch·ªâ cho ph√©p ch·ªçn ƒë·∫øn ng√†y mai
      dateInput.value = formatDate(today);    // M·∫∑c ƒë·ªãnh l√† h√¥m nay
      // ----------------------------

      new bootstrap.Modal(document.getElementById("bookingModal")).show();
    }
    // Update count in Booking Modal
    const countEl = document.getElementById("cartItemCount");
    const alertEl = document.getElementById("cartSummaryAlert");
    if (cart.length > 0) {
      countEl.textContent = cart.reduce((total, item) => total + item.qty, 0);
      alertEl.classList.remove("d-none");
    } else {
      alertEl.classList.add("d-none");
    }

    // Default Values
    document.getElementById("bookName").value = CURRENT_USER.name || "";
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("bookDate").value = today;
    document.getElementById("bookDate").min = today;

    const now = new Date();
    const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
    const timeString = oneHourLater.getHours().toString().padStart(2, "0") + ":" + oneHourLater.getMinutes().toString().padStart(2, "0");
    document.getElementById("bookTime").value = timeString;

    bootstrap.Modal.getOrCreateInstance(document.getElementById("bookingModal")).show();
  }

  document.getElementById("bookingForm").onsubmit = async function (e) {
    e.preventDefault();
    const btn = this.querySelector("button[type=submit]");
    const oldText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> X·ª≠ l√Ω...';
    btn.disabled = true;

    try {
      const payload = {
        restaurantId: REST_ID,
        userId: CURRENT_USER.id,
        customerName: document.getElementById("bookName").value,
        phone: document.getElementById("bookPhone").value,
        date: document.getElementById("bookDate").value,
        time: document.getElementById("bookTime").value + ":00",
        guests: parseInt(document.getElementById("bookGuestsRange").value),
        note: document.getElementById("bookNote").value,
        tableNumber: null, // Staff will assign
        items: bookingWithCart && cart.length > 0 ? cart.map((i) => ({ name: i.name, qty: i.qty, price: i.price })) : [],
      };

      const res = await fetch("http://localhost:8080/api/bookings/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`
        },
        body: JSON.stringify(payload),
      });

      const result = await res.json();
      if (res.ok && result.success) {
        alert("üéâ G·ª≠i y√™u c·∫ßu th√†nh c√¥ng! M√£ ƒë∆°n: #" + result.id);
        if (bookingWithCart) { cart = []; saveCart(); }
        bootstrap.Modal.getOrCreateInstance(document.getElementById("bookingModal")).hide();
        setTimeout(() => { window.location.href = "tracking.html"; }, 1000);
      } else {
        alert("L·ªói: " + (result.message || "Th·∫•t b·∫°i"));
      }
    } catch (err) {
      alert("L·ªói k·∫øt n·ªëi: " + err.message);
    } finally {
      btn.innerHTML = oldText;
      btn.disabled = false;
    }
  };

  function openBookingWithCart() {
    if (cart.length === 0) return alert("Gi·ªè h√†ng tr·ªëng!");
    openBookingModal(true);
  }

  // START
  init();
</script>
</body>
</html>