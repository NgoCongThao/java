<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S2O - Theo dõi đơn hàng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #e85d04;
        --success: #2e8b57;
        --gray: #adb5bd;
        --bg: #f8f9fa;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg);
        padding-bottom: 80px;
      }

      /* HEADER & NOTIF */
      .sticky-header {
        position: sticky;
        top: 0;
        z-index: 1020;
        background: white;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .notif-dropdown {
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        border: none;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        border-radius: 12px;
      }
      .notif-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: 0.2s;
      }
      .notif-item:hover {
        background: #f8f9fa;
      }
      .notif-item.unread {
        background: #fff8f3;
        border-left: 3px solid var(--primary);
      }

      /* TABS */
      .order-tabs {
        display: flex;
        background: white;
        border-bottom: 1px solid #eee;
        overflow-x: auto;
      }
      .order-tab {
        flex: 1;
        padding: 15px;
        border: none;
        background: none;
        font-weight: 600;
        color: #666;
        border-bottom: 3px solid transparent;
        white-space: nowrap;
      }
      .order-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      /* ORDER CARD */
      .order-card {
        background: white;
        border-radius: 16px;
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        overflow: hidden;
      }
      .order-header {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
      }
      .res-img {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        object-fit: cover;
        background: #eee;
      }
      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
      }

      /* PROGRESS BAR - ĐÃ SỬA LẠI */
      .progress-track {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin: 25px 10px 10px;
      }
      .progress-bg {
        position: absolute;
        top: 14px;
        left: 0;
        width: 100%;
        height: 4px;
        background: #eee;
        z-index: 1;
        border-radius: 2px;
      }
      .progress-fill {
        position: absolute;
        top: 14px;
        left: 0;
        height: 4px;
        background: var(--primary);
        z-index: 1;
        transition: 0.5s;
        border-radius: 2px;
      }
      .step {
        position: relative;
        z-index: 2;
        text-align: center;
        width: 25%;
      }
      .step-icon {
        width: 32px;
        height: 32px;
        background: #eee;
        border-radius: 50%;
        margin: 0 auto 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #adb5bd;
        border: 3px solid white;
        font-size: 0.9rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .step.active .step-icon {
        background: var(--primary);
        color: white;
        box-shadow: 0 0 0 3px rgba(232, 93, 4, 0.2);
      }
      .step.completed .step-icon {
        background: var(--success);
        color: white;
      }
      .step-label {
        font-size: 0.7rem;
        color: #999;
        font-weight: 500;
      }
      .step.active .step-label {
        color: var(--primary);
        font-weight: 700;
      }

      /* NOTE & TABLE */
      .note-box {
        background-color: #fff8e1;
        color: #b7791f;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.85rem;
        margin-top: 12px;
        border: 1px dashed #f6e05e;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }
      .table-badge {
        font-size: 0.75rem;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 6px;
        background: #f1f5f9;
        color: #64748b;
        margin-right: 5px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      .table-badge.active {
        background: #dcfce7;
        color: #166534;
      }

      /* UTILS */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
      }
      .empty-state i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 20px;
      }

      /* NAV */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 10px 0;
        border-top: 1px solid #eee;
        z-index: 1030;
      }
      .nav-link-custom {
        text-align: center;
        color: #999;
        text-decoration: none;
        flex: 1;
        display: block;
      }
      .nav-link-custom.active {
        color: var(--primary);
      }
      .nav-link-custom i {
        font-size: 1.4rem;
      }
      .nav-link-custom span {
        font-size: 0.7rem;
        display: block;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <header class="sticky-header">
      <div class="container d-flex justify-content-between align-items-center">
        <h1 class="h5 mb-0 fw-bold">Đơn hàng của bạn</h1>
        <div class="dropdown">
          <div
            class="position-relative cursor-pointer"
            data-bs-toggle="dropdown"
          >
            <i class="bi bi-bell fs-4"></i>
            <span
              id="notifBadge"
              class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none"
            ></span>
          </div>
          <ul
            class="dropdown-menu dropdown-menu-end notif-dropdown"
            id="notifList"
          >
            <li class="text-center p-3 text-muted small">
              Không có thông báo mới
            </li>
          </ul>
        </div>
      </div>
    </header>

    <div class="order-tabs">
      <button class="order-tab active" onclick="App.filter('SHIP', this)">
        Mang về / Ship
      </button>
      <button class="order-tab" onclick="App.filter('TABLE', this)">
        Đặt bàn / Tại bàn
      </button>
      <button class="order-tab" onclick="App.filter('HISTORY', this)">
        Lịch sử
      </button>
    </div>

    <main class="container mt-3" id="ordersContainer">
      <div class="text-center py-5 text-muted">
        <div
          class="spinner-border spinner-border-sm text-warning"
          role="status"
        ></div>
        <div class="mt-2 small">Đang tải dữ liệu...</div>
      </div>
    </main>

    <template id="emptyStateTpl">
      <div class="empty-state">
        <i class="bi bi-clipboard2-x"></i>
        <h5 class="text-muted">Bạn chưa có đơn hàng nào</h5>
        <p class="text-muted small mb-4">
          Hãy quét mã QR tại bàn để gọi món nhé!
        </p>
        <a
          href="restaurant-list.html"
          class="btn btn-warning text-white rounded-pill px-4 fw-bold shadow-sm"
          >Xem thực đơn</a
        >
      </div>
    </template>

    <template id="loginRequiredTpl">
      <div class="text-center py-5">
        <i class="bi bi-shield-lock display-1 text-muted"></i>
        <h5 class="mt-3">Vui lòng đăng nhập</h5>
        <p class="text-muted mb-4">Bạn cần đăng nhập để xem lịch sử gọi món</p>
        <a
          href="authcus.html"
          class="btn btn-warning text-white px-4 rounded-pill fw-bold"
          >Đăng nhập ngay</a
        >
      </div>
    </template>

    <nav class="bottom-nav">
      <div class="d-flex justify-content-around">
        <a href="restaurant-list.html" class="nav-link-custom"
          ><i class="bi bi-house"></i><span>Trang chủ</span></a
        >
        <a href="tracking.html" class="nav-link-custom active"
          ><i class="bi bi-receipt"></i><span>Đơn hàng</span></a
        >
        <a href="profile.html" class="nav-link-custom"
          ><i class="bi bi-person"></i><span>Tài khoản</span></a
        >
      </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API_CONFIG = {
        BASE_URL: "/api",
        ORDERS_ENDPOINT: (id) => `/orders/my-orders/${id}`,
        BOOKINGS_ENDPOINT: (id) => `/bookings/user/${id}`,
        NOTIF_ENDPOINT: "/notifications",
      };

      // ĐÃ SỬA: Icon và Label phù hợp ăn tại quán
      const STATUS_MAP = {
        PENDING: { label: "Chờ xác nhận", color: "#ffc107", step: 1 },
        COOKING: { label: "Bếp đang nấu", color: "#e85d04", step: 2 },
        DELIVERING: { label: "Đang lên món", color: "#0dcaf0", step: 3 },
        COMPLETED: { label: "Hoàn tất", color: "#198754", step: 4 },
        CANCELLED: { label: "Đã hủy", color: "#dc3545", step: 0 },
      };

      const IMG_BACKUP = "../img/anhbackup.jpg";

      const ApiService = {
        async get(endpoint) {
          try {
            const token = localStorage.getItem("token");
            const res = await fetch(`${API_CONFIG.BASE_URL}${endpoint}`, {
              headers: {
                Authorization: token ? `Bearer ${token}` : "",
                "Content-Type": "application/json",
              },
            });
            if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
            return await res.json();
          } catch (error) {
            console.error("API Error:", error);
            return [];
          }
        },
      };

      const App = {
        allItems: [],

        async init() {
          const container = document.getElementById("ordersContainer");
          const token = localStorage.getItem("token");
          const userStr = localStorage.getItem("user");

          if (!token || !userStr) {
            container.innerHTML =
              document.getElementById("loginRequiredTpl").innerHTML;
            document.querySelector(".order-tabs").style.display = "none";
            return;
          }

          const user = JSON.parse(userStr);
          const userId = user.id || 1;

          try {
            // Gọi song song cả orders và bookings
            const [orders, bookings] = await Promise.all([
              ApiService.get(API_CONFIG.ORDERS_ENDPOINT(userId)),
              ApiService.get(API_CONFIG.BOOKINGS_ENDPOINT(userId)),
            ]);

            console.log("Orders:", orders);
            console.log("Bookings:", bookings);

            // Thêm type để phân biệt
            const ordersWithType = orders.map((o) => ({
              ...o,
              type: "order",
            }));
            const bookingsWithType = bookings.map((b) => ({
              ...b,
              type: "booking",
            }));

            // Gộp và sắp xếp đơn mới nhất lên đầu
            const allItems = [...ordersWithType, ...bookingsWithType];
            allItems.sort((a, b) => {
              const dateA = new Date(a.createdAt || a.bookingDate || 0);
              const dateB = new Date(b.createdAt || b.bookingDate || 0);
              return dateB - dateA;
            });

            this.allItems = allItems;
            this.renderItems(this.allItems);
          } catch (err) {
            console.error("Init error:", err);
            container.innerHTML = `<div class="text-center py-5 text-danger">Không tải được dữ liệu.</div>`;
          }
        },

        renderItems(items) {
          const container = document.getElementById("ordersContainer");

          if (!items || items.length === 0) {
            container.innerHTML =
              document.getElementById("emptyStateTpl").innerHTML;
            return;
          }

          let html = "";
          items.forEach((item) => {
            const statusCfg = STATUS_MAP[item.status] || STATUS_MAP["PENDING"];
            const isDone = ["COMPLETED", "CANCELLED"].includes(item.status);

            // Xử lý danh sách món ăn
            const itemsHtml = (item.items || [])
              .map(
                (i) =>
                  `<div><b class="text-primary">${i.quantity || i.qty}x</b> ${i.itemName || i.name}</div>`,
              )
              .join("");

            // --- 1. XỬ LÝ THANH TIẾN TRÌNH ---
            let progressHtml = "";
            if (!isDone && item.type === "order") {
              const pct = ((statusCfg.step - 1) / 3) * 100;
              progressHtml = `
                <div class="progress-track">
                  <div class="progress-bg"></div>
                  <div class="progress-fill" style="width: ${pct}%"></div>
                  ${this.renderSteps(statusCfg.step)}
                </div>
              `;
            }

            // --- 2. NGÀY GIỜ ---
            let dateInfo = "";
            const dateStr = item.createdAt || item.bookingDate;
            if (dateStr) {
              dateInfo = new Date(dateStr).toLocaleString("vi-VN", {
                hour: "2-digit",
                minute: "2-digit",
                day: "2-digit",
                month: "2-digit",
              });
            }

            // --- 3. LẤY TÊN NHÀ HÀNG ---
            let restaurantName = "Nhà hàng S2O";
            let restaurantImage = IMG_BACKUP;

            if (item.type === "order") {
              restaurantName = item.restaurantName || "Nhà hàng S2O";
              restaurantImage = item.img || IMG_BACKUP;
            } else if (item.type === "booking") {
              // Code mới sẽ chạy vào đây vì item.restaurant bây giờ đã có dữ liệu
              if (item.restaurant) {
                restaurantName = item.restaurant.name;
                restaurantImage = item.restaurant.image || IMG_BACKUP;
              }
            }
            // --- 4. HIỂN THỊ BADGE LOẠI ĐƠN ---
            let tableHtml = "";
            const tableNumber = item.tableNumber || 0;

            if (item.type === "booking") {
              // Booking luôn hiển thị badge xanh
              tableHtml = `
                <span class="badge bg-success bg-opacity-10 text-success border border-success px-2 py-1">
                  <i class="bi bi-calendar-check me-1"></i> Đặt bàn ${tableNumber > 0 ? `Bàn ${tableNumber}` : ""}
                </span>`;
            } else if (tableNumber > 0) {
              // Order có bàn
              tableHtml = `
                <span class="badge bg-success bg-opacity-10 text-success border border-success px-2 py-1">
                  <i class="bi bi-shop me-1"></i> Bàn số ${tableNumber}
                </span>`;
            } else {
              // Order không có bàn (mang về/ship)
              tableHtml = `
                <span class="badge bg-warning bg-opacity-10 text-warning border border-warning px-2 py-1">
                  <i class="bi bi-bag me-1"></i> Mang về / Ship
                </span>`;
            }

            // --- 5. HIỂN THỊ GHI CHÚ ---
            let noteHtml = "";
            if (item.note && item.note.trim() !== "") {
              noteHtml = `
                <div class="note-box">
                  <i class="bi bi-pencil-square mt-1"></i> 
                  <div><strong>Ghi chú:</strong> ${item.note}</div>
                </div>`;
            }

            // --- 6. TÍNH TỔNG TIỀN ---
            let totalAmount = 0;
            if (item.type === "order") {
              totalAmount = item.totalPrice || item.total || 0;
            } else if (item.type === "booking") {
              // Tính tổng tiền từ danh sách items trong booking
              if (item.items && item.items.length > 0) {
                totalAmount = item.items.reduce((sum, i) => {
                  const price = i.price || 0;
                  const quantity = i.quantity || i.qty || 0;
                  return sum + price * quantity;
                }, 0);
              }
            }

            // --- RENDER HTML CARD ---
            html += `
              <div class="order-card">
                <div class="order-header">
                  <div class="d-flex align-items-center gap-3">
                    <img src="${restaurantImage}" class="res-img" onerror="this.src='${IMG_BACKUP}'">
                    <div>
                      <div class="fw-bold text-dark">${restaurantName}</div>
                      <div class="d-flex align-items-center gap-2 mt-1">
                          ${tableHtml}
                          <span class="small text-muted">#${item.id} • ${dateInfo}</span>
                      </div>
                    </div>
                  </div>
                  <span class="status-badge" style="background:${statusCfg.color}20; color:${statusCfg.color}">${statusCfg.label}</span>
                </div>
                
                <div class="p-3 pt-0">
                  ${progressHtml}
                  
                  <div class="mt-3 small text-secondary" style="line-height:1.6; border-left: 3px solid #eee; padding-left: 10px;">
                      ${itemsHtml}
                  </div>

                  ${noteHtml}
                </div>

                <div class="p-3 border-top d-flex justify-content-between align-items-center bg-light">
                  <div>
                    <span class="small text-muted">Tổng tiền:</span>
                    <span class="fw-bold text-primary fs-5 ms-1">${totalAmount.toLocaleString()}đ</span>
                  </div>
                  ${
                    item.status === "COMPLETED"
                      ? '<button class="btn btn-sm btn-outline-primary rounded-pill px-3 fw-bold">Đánh giá</button>'
                      : '<button class="btn btn-sm btn-outline-dark rounded-pill px-3 fw-bold">Chi tiết</button>'
                  }
                </div>
              </div>
            `;
          });
          container.innerHTML = html;
        },

        renderSteps(current) {
          const steps = ["Đã đặt", "Đang nấu", "Đang lên món", "Hoàn tất"];
          const icons = [
            "bi-receipt",
            "bi-fire",
            "bi-bell-fill",
            "bi-check-circle-fill",
          ];

          return steps
            .map((label, idx) => {
              const stepNum = idx + 1;
              let cls = "";
              if (stepNum < current) cls = "completed";
              else if (stepNum === current) cls = "active";

              return `
                <div class="step ${cls}">
                    <div class="step-icon"><i class="bi ${icons[idx]}"></i></div>
                    <div class="step-label">${label}</div>
                </div>`;
            })
            .join("");
        },

        // --- ĐOẠN CODE MỚI THAY THẾ ---
        filter(type, btn) {
          // 1. Cập nhật giao diện Tab đang chọn
          document
            .querySelectorAll(".order-tab")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          let filtered = [];

          // Hàm kiểm tra trạng thái ĐANG XỬ LÝ (Chưa xong, chưa hủy)
          const isActive = (status) =>
            !["COMPLETED", "CANCELLED", "REJECTED"].includes(status);

          if (type === "SHIP") {
            // TAB 1: MANG VỀ / SHIP
            // Logic: Là đơn món (order) + Không có số bàn + Đang xử lý
            filtered = this.allItems.filter(
              (item) =>
                item.type === "order" &&
                (!item.tableNumber || item.tableNumber === 0) &&
                isActive(item.status),
            );
          } else if (type === "TABLE") {
            // TAB 2: ĐẶT BÀN / TẠI BÀN
            // Logic: (Là Booking đang xử lý) HOẶC (Là Order có số bàn đang xử lý)
            filtered = this.allItems.filter((item) => {
              const isBooking =
                item.type === "booking" && isActive(item.status);
              const isOrderAtTable =
                item.type === "order" &&
                item.tableNumber > 0 &&
                isActive(item.status);
              return isBooking || isOrderAtTable;
            });
          } else if (type === "HISTORY") {
            // TAB 3: LỊCH SỬ
            // Logic: Đã hoàn thành hoặc Đã hủy (Bất kể là Order hay Booking)
            filtered = this.allItems.filter((item) => !isActive(item.status));
          }

          this.renderList(filtered);
        },
        // -----------------------------
      };

      document.addEventListener("DOMContentLoaded", () => App.init());
    </script>
  </body>
</html>
