<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S2O - Hồ sơ cá nhân</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #e85d04;
        --bg: #f3f4f6;
        --text-dark: #1f2937;
        --text-gray: #6b7280;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg);
        padding-bottom: 80px;
        color: var(--text-dark);
      }

      /* HEADER */
      .profile-header {
        background: linear-gradient(135deg, #ff6b35 0%, #e85d04 100%);
        padding: 50px 20px 60px;
        color: white;
        border-bottom-left-radius: 30px;
        border-bottom-right-radius: 30px;
        text-align: center;
        box-shadow: 0 10px 20px rgba(232, 93, 4, 0.2);
        position: relative;
        margin-bottom: 50px;
      }

      .avatar-box {
        width: 90px;
        height: 90px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary);
        margin: 0 auto 15px;
        border: 4px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .rank-tag {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        backdrop-filter: blur(4px);
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-top: 5px;
      }

      /* STATS CARD */
      .stats-card {
        background: white;
        border-radius: 20px;
        padding: 20px;
        margin: -40px 20px 20px;
        display: flex;
        justify-content: space-around;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        position: relative;
        z-index: 10;
      }
      .stat-col {
        text-align: center;
      }
      .stat-num {
        font-weight: 800;
        font-size: 1.1rem;
        color: var(--text-dark);
        display: block;
      }
      .stat-name {
        font-size: 0.75rem;
        color: var(--text-gray);
        font-weight: 500;
      }

      /* MENU SECTION */
      .section-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-gray);
        margin: 20px 25px 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .menu-list {
        background: white;
        border-radius: 20px;
        margin: 0 20px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
      }

      .menu-link {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        text-decoration: none;
        color: var(--text-dark);
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
        cursor: pointer;
      }
      .menu-link:last-child {
        border-bottom: none;
      }
      .menu-link:active {
        background-color: #f9fafb;
      }

      .icon-box {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.1rem;
      }
      .bg-orange {
        background: #fff7ed;
        color: #ea580c;
      }
      .bg-blue {
        background: #eff6ff;
        color: #2563eb;
      }
      .bg-green {
        background: #f0fdf4;
        color: #16a34a;
      }
      .bg-purple {
        background: #faf5ff;
        color: #9333ea;
      }
      .bg-gray {
        background: #f3f4f6;
        color: #4b5563;
      }

      .menu-content {
        flex: 1;
      }
      .menu-label {
        font-weight: 500;
        font-size: 0.95rem;
        display: block;
      }
      .menu-sub {
        font-size: 0.8rem;
        color: var(--text-gray);
        margin-top: 2px;
        display: block;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* LOGOUT BUTTON */
      .btn-logout {
        margin: 30px 20px 10px;
        background: #fee2e2;
        color: #dc2626;
        border: none;
        width: calc(100% - 40px);
        padding: 14px;
        border-radius: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 0.2s;
      }
      .btn-logout:active {
        background: #fecaca;
      }

      /* BOTTOM NAV */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: white;
        display: flex;
        justify-content: space-around;
        padding: 12px 0;
        border-top: 1px solid #eee;
        z-index: 100;
      }
      .nav-btn {
        text-align: center;
        color: #9ca3af;
        text-decoration: none;
        flex: 1;
      }
      .nav-btn.active {
        color: var(--primary);
      }
      .nav-btn i {
        font-size: 1.4rem;
        display: block;
        margin-bottom: 2px;
      }
      .nav-btn span {
        font-size: 0.7rem;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="profile-header">
      <div class="avatar-box" id="avatarText">U</div>
      <h4 id="userName" class="fw-bold mb-1">Đang tải...</h4>
      <div id="userPhone" class="opacity-75 small">...</div>
      <div class="rank-tag">
        <i class="bi bi-star-fill text-warning"></i> Thành viên
      </div>
    </div>

    <div class="stats-card">
      <div class="stat-col">
        <span class="stat-num" id="statOrders">0</span>
        <span class="stat-name">Đơn hàng</span>
      </div>
      <div class="stat-col border-start border-end px-3">
        <span class="stat-num" id="statPoints">0</span>
        <span class="stat-name">Điểm thưởng</span>
      </div>
      <div class="stat-col">
        <span class="stat-num" id="statVouchers">0</span>
        <span class="stat-name">Voucher</span>
      </div>
    </div>

    <div class="section-title">Tài khoản</div>
    <div class="menu-list">
      <div class="menu-link" onclick="openAddressModal()">
        <div class="icon-box bg-orange"><i class="bi bi-geo-alt-fill"></i></div>
        <div class="menu-content">
          <span class="menu-label">Địa chỉ giao hàng</span>
          <span class="menu-sub" id="currentAddrText">Chưa cập nhật</span>
        </div>
        <i class="bi bi-chevron-right text-muted small"></i>
      </div>

      <div class="menu-link">
        <div class="icon-box bg-blue"><i class="bi bi-wallet2"></i></div>
        <div class="menu-content">
          <span class="menu-label">Ví & Thanh toán</span>
          <span class="menu-sub">Liên kết thẻ, Ví điện tử</span>
        </div>
        <i class="bi bi-chevron-right text-muted small"></i>
      </div>
    </div>

    <div class="section-title">Cài đặt & Hỗ trợ</div>
    <div class="menu-list">
      <div class="menu-link" onclick="openPasswordModal()">
        <div class="icon-box bg-purple">
          <i class="bi bi-shield-lock-fill"></i>
        </div>
        <div class="menu-content">
          <span class="menu-label">Đổi mật khẩu</span>
          <span class="menu-sub">Tăng cường bảo mật</span>
        </div>
        <i class="bi bi-chevron-right text-muted small"></i>
      </div>

      <div class="menu-link">
        <div class="icon-box bg-green"><i class="bi bi-bell-fill"></i></div>
        <div class="menu-content">
          <span class="menu-label">Thông báo</span>
          <span class="menu-sub">Tin tức, Khuyến mãi</span>
        </div>
        <div class="form-check form-switch ms-2">
          <input class="form-check-input" type="checkbox" checked />
        </div>
      </div>

      <a href="chatbot.html" class="menu-link">
        <div class="icon-box bg-gray"><i class="bi bi-robot"></i></div>
        <div class="menu-content">
          <span class="menu-label">Chatbot AI</span>
          <span class="menu-sub">Hỗ trợ tự động 24/7</span>
        </div>
        <i class="bi bi-chevron-right text-muted small"></i>
      </a>
    </div>

    <button class="btn-logout" onclick="logout()">
      <i class="bi bi-box-arrow-right"></i> Đăng xuất
    </button>

    <div class="text-center mt-3 pb-3 small text-muted opacity-50">
      S2O App v1.0.0
    </div>

    <div class="modal fade" id="addressModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">Cập nhật địa chỉ</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <label class="form-label text-muted small fw-bold"
                >ĐỊA CHỈ HIỆN TẠI</label
              >
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0"
                  ><i class="bi bi-geo-alt text-primary"></i
                ></span>
                <input
                  type="text"
                  id="inputAddress"
                  class="form-control bg-light border-start-0"
                  placeholder="Số nhà, tên đường, phường..."
                />
              </div>
            </div>
            <button
              onclick="saveAddress()"
              class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm"
            >
              Lưu thay đổi
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="passwordModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">Đổi mật khẩu</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label text-muted small fw-bold"
                >MẬT KHẨU CŨ</label
              >
              <input
                type="password"
                id="oldPass"
                class="form-control bg-light border-0"
              />
            </div>
            <div class="mb-4">
              <label class="form-label text-muted small fw-bold"
                >MẬT KHẨU MỚI</label
              >
              <input
                type="password"
                id="newPass"
                class="form-control bg-light border-0"
              />
            </div>
            <button
              onclick="changePassword()"
              class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm"
            >
              Xác nhận
            </button>
          </div>
        </div>
      </div>
    </div>

    <nav class="bottom-nav">
      <a href="restaurant-list.html" class="nav-btn">
        <i class="bi bi-house"></i><span>Trang chủ</span>
      </a>
      <a href="tracking.html" class="nav-btn">
        <i class="bi bi-receipt"></i><span>Đơn hàng</span>
      </a>
      <a href="profile.html" class="nav-btn active">
        <i class="bi bi-person-fill"></i><span>Tài khoản</span>
      </a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentUser = null;
      const token = localStorage.getItem("token");

      document.addEventListener("DOMContentLoaded", async function () {
        if (!token) {
          window.location.href = "authcus.html";
          return;
        }

        // 1. Load thông tin cơ bản từ LocalStorage
        const userStr = localStorage.getItem("user");
        if (userStr) {
          currentUser = JSON.parse(userStr);
          renderInfo(currentUser);
        }

        // 2. Gọi API lấy thống kê đơn hàng & Hạng thành viên
        await fetchUserStats();
      });

      function renderInfo(user) {
        const name = user.fullName || user.username || "Khách hàng";
        document.getElementById("userName").textContent = name;
        document.getElementById("userPhone").textContent =
          user.phone || user.username;
        document.getElementById("avatarText").textContent = name
          .charAt(0)
          .toUpperCase();

        if (user.address) {
          document.getElementById("currentAddrText").textContent = user.address;
          document.getElementById("inputAddress").value = user.address;
        }
      }

      // --- HÀM MỚI: LẤY THỐNG KÊ & HẠNG ---
      async function fetchUserStats() {
        try {
          const res = await fetch(`/api/stats/user/${currentUser.id}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.ok) {
            const data = await res.json();

            // Cập nhật số đơn hàng
            document.getElementById("statOrders").textContent =
              data.totalOrders;

            // Cập nhật Rank (Huy hiệu)
            updateRankUI(data.rank);
          }
        } catch (e) {
          console.error("Lỗi lấy stats:", e);
        }
      }

      function updateRankUI(rank) {
        const rankTag = document.querySelector(".rank-tag");
        let icon = "bi-star-fill";
        let colorClass = "text-warning"; // Mặc định màu vàng

        // Logic màu sắc cho từng hạng
        if (rank === "Đồng") {
          colorClass = "text-secondary"; // Màu xám nâu
          icon = "bi-award";
        } else if (rank === "Bạc") {
          colorClass = "text-secondary"; // Màu bạc (xám sáng)
          icon = "bi-award-fill";
          rankTag.style.background = "rgba(192, 192, 192, 0.3)";
        } else if (rank === "Vàng") {
          colorClass = "text-warning"; // Màu vàng
          icon = "bi-trophy-fill";
          rankTag.style.background = "rgba(255, 215, 0, 0.3)";
        } else if (rank === "Kim Cương") {
          colorClass = "text-info"; // Màu xanh dương sáng
          icon = "bi-gem";
          rankTag.style.background = "rgba(0, 255, 255, 0.2)";
        }

        rankTag.innerHTML = `<i class="bi ${icon} ${colorClass}"></i> Thành viên ${rank}`;
      }

      // --- LOGIC ĐỊA CHỈ (Giữ nguyên) ---
      function openAddressModal() {
        new bootstrap.Modal(document.getElementById("addressModal")).show();
      }

      async function saveAddress() {
        const newAddr = document.getElementById("inputAddress").value;
        if (!newAddr) return alert("Vui lòng nhập địa chỉ!");

        try {
          const res = await fetch(`/api/users/${currentUser.id}/address`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ address: newAddr }),
          });

          if (res.ok) {
            alert("Cập nhật địa chỉ thành công!");
            currentUser.address = newAddr;
            localStorage.setItem("user", JSON.stringify(currentUser));
            renderInfo(currentUser);
            bootstrap.Modal.getInstance(
              document.getElementById("addressModal"),
            ).hide();
          } else {
            alert("Lỗi cập nhật!");
          }
        } catch (e) {
          console.error(e);
          alert("Lỗi kết nối Server!");
        }
      }

      // --- LOGIC ĐỔI PASSWORD (Giữ nguyên) ---
      function openPasswordModal() {
        new bootstrap.Modal(document.getElementById("passwordModal")).show();
      }

      async function changePassword() {
        const oldPass = document.getElementById("oldPass").value;
        const newPass = document.getElementById("newPass").value;

        if (!oldPass || !newPass) return alert("Vui lòng nhập đủ thông tin!");

        try {
          const res = await fetch(`/api/auth/change-password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              userId: currentUser.id,
              oldPassword: oldPass,
              newPassword: newPass,
            }),
          });

          if (res.ok) {
            alert("Đổi mật khẩu thành công! Vui lòng đăng nhập lại.");
            logout();
          } else {
            const txt = await res.text();
            alert("Lỗi: " + txt);
          }
        } catch (e) {
          console.error(e);
          alert("Lỗi kết nối Server!");
        }
      }

      function logout() {
        if (confirm("Bạn có chắc muốn đăng xuất?")) {
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          window.location.href = "authcus.html";
        }
      }
    </script>
  </body>
</html>
