<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S2O - Danh sách nhà hàng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/chatbot.css" />

    <style>
      :root {
        --primary-color: #e85d04;
        --primary-light: #ff9e66;
        --light-bg: #f8f9fa;
        --gray-light: #e9ecef;
        --gray-medium: #adb5bd;
        --gray-dark: #495057;
        --success-color: #2e8b57;
        --closed-color: #6c757d;
      }
      * {
        font-family: "Inter", sans-serif;
      }
      body {
        background-color: #ffffff;
        padding-bottom: 70px;
      }

      /* Sticky Search Header */
      .sticky-search {
        position: sticky;
        top: 0;
        z-index: 1020;
        background-color: white;
        padding: 12px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .search-bar {
        border-radius: 50px;
        border: 1px solid var(--gray-light);
        padding-left: 45px;
        background-color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }
      .search-bar:focus {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(232, 93, 4, 0.15);
      }
      .search-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-medium);
        z-index: 5;
      }

      /* Categories */
      .categories-container {
        overflow-x: auto;
        white-space: nowrap;
        padding: 10px 0;
        margin-bottom: 10px;
        -webkit-overflow-scrolling: touch;
      }
      .categories-container::-webkit-scrollbar {
        height: 3px;
      }
      .categories-container::-webkit-scrollbar-thumb {
        background: var(--primary-light);
        border-radius: 10px;
      }
      .category-pill {
        display: inline-block;
        padding: 8px 16px;
        margin-right: 8px;
        border-radius: 50px;
        background-color: var(--gray-light);
        color: var(--gray-dark);
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        border: none;
      }
      .category-pill:hover,
      .category-pill.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* Restaurant Cards */
      .restaurant-card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--gray-light);
        transition:
          transform 0.3s ease,
          box-shadow 0.3s ease;
        margin-bottom: 20px;
        height: 100%;
      }
      .restaurant-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(232, 93, 4, 0.1);
      }
      .restaurant-img {
        width: 100%;
        height: 160px;
        object-fit: cover;
      }
      .restaurant-info {
        padding: 15px;
      }
      .restaurant-name {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 5px;
        color: var(--gray-dark);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      /* Utilities */
      .verified-badge {
        color: var(--primary-color);
        margin-left: 5px;
        font-size: 0.9rem;
      }
      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 10px;
      }
      .status-open {
        background-color: rgba(46, 139, 87, 0.1);
        color: var(--success-color);
      }
      .status-closed {
        background-color: rgba(108, 117, 125, 0.1);
        color: var(--closed-color);
      }
      .distance-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        background-color: rgba(232, 93, 4, 0.1);
        color: var(--primary-color);
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }
      .restaurant-meta {
        display: flex;
        justify-content: space-between;
        color: var(--gray-medium);
        font-size: 0.9rem;
      }
      .rating {
        color: #ffc107;
      }
      .favorite-btn {
        background: none;
        border: none;
        color: var(--gray-medium);
        font-size: 1.2rem;
        transition: all 0.2s ease;
        padding: 0;
      }
      .favorite-btn:hover {
        color: #dc3545;
        transform: scale(1.1);
      }
      .favorite-btn.active {
        color: #dc3545;
      }

      /* UI Elements */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray-medium);
      }
      .empty-state-icon {
        font-size: 4rem;
        color: var(--gray-light);
        margin-bottom: 20px;
      }
      .location-prompt {
        background-color: rgba(232, 93, 4, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .spinner-container {
        display: flex;
        justify-content: center;
        padding: 40px;
      }

      /* Bottom Nav */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08);
        z-index: 1030;
        padding: 10px 0;
      }
      .nav-item {
        text-align: center;
        color: var(--gray-medium);
        text-decoration: none;
        flex: 1;
        padding: 8px 0;
        transition: color 0.2s ease;
      }
      .nav-item.active,
      .nav-item:hover {
        color: var(--primary-color);
      }
      .nav-icon {
        font-size: 1.4rem;
        display: block;
        margin-bottom: 3px;
      }
      .nav-text {
        font-size: 0.75rem;
        font-weight: 500;
      }

      @media (min-width: 768px) {
        .restaurant-img {
          height: 180px;
        }
        .category-pill {
          padding: 10px 20px;
          font-size: 1rem;
        }
      }
      @media (min-width: 992px) {
        .restaurant-img {
          height: 200px;
        }
      }
    </style>
  </head>
  <body>
    <header class="sticky-search">
      <div class="container">
        <div class="row align-items-center">
          <div class="col">
            <h1
              class="h4 mb-0"
              style="color: var(--primary-color); font-weight: 700"
            >
              S2O Restaurants
            </h1>
            <p class="text-muted mb-0 small">Đặt món nhanh với QR Code</p>
          </div>
          <div class="col-auto">
            <div class="position-relative">
              <i class="bi bi-search search-icon"></i>
              <input
                type="text"
                class="form-control search-bar"
                id="searchInput"
                placeholder="Tìm nhà hàng, món ăn..."
              />
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="container">
      <div id="locationPrompt" class="location-prompt" style="display: none">
        <div>
          <i
            class="bi bi-geo-alt-fill"
            style="color: var(--primary-color); font-size: 1.2rem"
          ></i>
          <span class="ms-2"
            >Cho phép S2O truy cập vị trí để tìm nhà hàng gần bạn</span
          >
        </div>
        <button id="enableLocation" class="btn btn-sm btn-primary">
          Cho phép
        </button>
      </div>

      <div class="categories-container">
        <div class="d-flex">
          <button class="category-pill active" data-category="all">
            Tất cả
          </button>
          <button class="category-pill" data-category="Cơm">Cơm</button>
          <button class="category-pill" data-category="Phở">Phở</button>
          <button class="category-pill" data-category="Trà sữa">Trà sữa</button>
          <button class="category-pill" data-category="Lẩu">Lẩu</button>
          <button class="category-pill" data-category="Gà rán">Gà rán</button>
          <button class="category-pill" data-category="Pizza">Pizza</button>
          <button class="category-pill" data-category="Đồ uống">Đồ uống</button>
        </div>
      </div>

      <div id="loadingSpinner" class="spinner-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Đang tải...</span>
        </div>
      </div>

      <div id="restaurantList" class="row"></div>

      <div id="emptyState" class="empty-state" style="display: none">
        <i class="bi bi-shop empty-state-icon"></i>
        <h4 class="mb-3">Không tìm thấy nhà hàng phù hợp</h4>
        <p class="text-muted">
          Hãy thử tìm kiếm với từ khóa khác hoặc chọn danh mục khác
        </p>
      </div>
      <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content text-center p-4">
            <h5 class="modal-title fw-bold mb-3" id="qrResName">
              Mã QR Nhà Hàng
            </h5>
            <div id="qrcode" class="d-flex justify-content-center mb-3"></div>
            <p class="text-muted small">Quét mã này để xem Menu & Đặt món</p>
            <p class="text-primary fw-bold small" id="qrLinkDisplay"></p>
            <button
              type="button"
              class="btn btn-secondary w-100"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </main>

    <nav class="bottom-nav">
      <div class="container">
        <div class="d-flex justify-content-around">
          <a href="restaurant-list.html" class="nav-item active">
            <i class="bi bi-house-door-fill nav-icon"></i
            ><span class="nav-text">Trang chủ</span>
          </a>
          <a href="tracking.html" class="nav-item">
            <i class="bi bi-receipt nav-icon"></i
            ><span class="nav-text">Đơn hàng</span>
          </a>
          <a href="#" class="nav-item" id="favoritesTab">
            <i class="bi bi-heart nav-icon"></i
            ><span class="nav-text">Yêu thích</span>
          </a>
          <a href="profile.html" class="nav-item">
            <i class="bi bi-person nav-icon"></i
            ><span class="nav-text">Tài khoản</span>
          </a>
        </div>
      </div>
    </nav>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/chatbot.js"></script>
    <script>
      // 1. CẤU HÌNH & SELECTORS
      const DOM = {
        list: document.getElementById("restaurantList"),
        search: document.getElementById("searchInput"),
        pills: document.querySelectorAll(".category-pill"),
        empty: document.getElementById("emptyState"),
        spinner: document.getElementById("loadingSpinner"),
        prompt: document.getElementById("locationPrompt"),
        btnLocation: document.getElementById("enableLocation"),
        tabFav: document.getElementById("favoritesTab"),
        navItems: document.querySelectorAll(".nav-item"),
      };

      let state = {
        restaurants: [],
        filter: {
          text: "",
          category: "all",
          favOnly: false,
          userLoc: null,
          sortByDist: true,
        },
      };

      // 2. LOGIC TÍNH TOÁN
      const Haversine = (lat1, lon1, lat2, lon2) => {
        const R = 6371;
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      };

      const updateDistances = (loc) => {
        state.restaurants = state.restaurants.map((r) => ({
          ...r,
          calculatedDistance: parseFloat(
            Haversine(
              loc.latitude,
              loc.longitude,
              r.latitude,
              r.longitude,
            ).toFixed(1),
          ),
        }));
      };

      // 3. LOGIC DỮ LIỆU
      const loadData = async () => {
        try {
          // --- SỬA ĐỔI: Gọi API từ Java Backend (Cổng 8080) ---
          const res = await fetch(
            "http://localhost:8080/api/guest/restaurants",
          );
          if (!res.ok) throw new Error("Lỗi kết nối API Backend");
          state.restaurants = await res.json();

          console.log("Dữ liệu tải về từ Java:", state.restaurants); // Dòng này để debug xem API trả về gì
        } catch (err) {
          console.error(err);
          alert(
            "Không thể kết nối đến Server! Hãy kiểm tra xem file WebApplication.java đã chạy chưa?",
          );
        }
      };

      // 4. LOGIC RENDER
      const render = () => {
        DOM.spinner.style.display = "flex";
        DOM.list.innerHTML = "";
        DOM.empty.style.display = "none";

        let display = [...state.restaurants];

        // Sắp xếp theo khoảng cách
        if (state.filter.userLoc && state.filter.sortByDist) {
          display.sort(
            (a, b) =>
              (a.calculatedDistance || 999) - (b.calculatedDistance || 999),
          );
        }

        // Lọc dữ liệu
        const filtered = display.filter((r) => {
          if (r.status !== "active") return false;
          if (state.filter.favOnly && !isFav(r.id)) return false;
          if (
            state.filter.category !== "all" &&
            r.category !== state.filter.category
          )
            return false;
          if (state.filter.text) {
            const term = state.filter.text.toLowerCase();
            return (
              r.name.toLowerCase().includes(term) ||
              r.category.toLowerCase().includes(term)
            );
          }
          return true;
        });

        if (filtered.length === 0) DOM.empty.style.display = "block";
        else filtered.forEach((r) => (DOM.list.innerHTML += createCard(r)));

        DOM.spinner.style.display = "none";
        initTooltips();
        bindFavEvents();
      };

      const createCard = (r) => {
        const isOpen = r.isOpen;
        const distBadge = r.calculatedDistance
          ? `<div class="distance-badge"><i class="bi bi-geo-alt me-1"></i><span>${r.calculatedDistance} km</span></div>`
          : `<div class="distance-badge" style="background:#e9ecef;color:#495057"><i class="bi bi-geo-alt-slash me-1"></i><span>-- km</span></div>`;

        // Render sao
        let stars = "";
        for (let i = 0; i < 5; i++) {
          if (i < Math.floor(r.rating))
            stars += '<i class="bi bi-star-fill rating"></i>';
          else if (i === Math.floor(r.rating) && r.rating % 1 >= 0.5)
            stars += '<i class="bi bi-star-half rating"></i>';
          else stars += '<i class="bi bi-star rating"></i>';
        }

        return `
  <div class="col-12 col-md-6 col-lg-4">
    <a href="menu.html?id=${r.id}" class="text-decoration-none text-dark">
        <div class="restaurant-card">
          <img 
            src="${r.image}" 
            class="restaurant-img" 
            alt="${r.name}" 
            onerror="this.onerror=null; this.src='../img/anhbackup.jpg';"
          >
          
          <div class="restaurant-info">
            <div class="restaurant-name">
                <div class="text-truncate" style="max-width: 70%;">
                  ${r.name} 
                  <i class="bi bi-patch-check-fill verified-badge" data-bs-toggle="tooltip" title="Đối tác"></i>
                </div>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-light btn-sm rounded-circle border" 
                            onclick="event.preventDefault(); showQR(${r.id}, '${r.name}')"
                            title="Lấy mã QR">
                        <i class="bi bi-qr-code"></i>
                    </button>

                    <button class="favorite-btn ${isFav(r.id) ? "active" : ""}" 
                          data-id="${r.id}"
                          onclick="event.preventDefault()"> 
                      <i class="bi ${isFav(r.id) ? "bi-heart-fill" : "bi-heart"}"></i>
                    </button>
                </div>
              </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="status-badge ${
                isOpen ? "status-open" : "status-closed"
              }">
                ${isOpen ? "Mở cửa" : "Đóng cửa"}
              </div>
              ${distBadge}
            </div>

            <div class="restaurant-meta">
              <div>${stars} <span class="ms-1">${r.rating}</span></div>
              <div><i class="bi bi-clock"></i> 25-30p</div>
            </div>

            <div class="mt-2 small text-muted">
                <i class="bi bi-tag"></i> ${r.category}
            </div>
          </div>
        </div>
    </a>
  </div>
`;
      };
      // --- HÀM MỚI: HIỂN THỊ QR CODE ---
      const showQR = (id, name) => {
        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = ""; // Xóa QR cũ

        document.getElementById("qrResName").textContent = name;

        // Tự động lấy IP/Domain hiện tại (VD: 192.168.1.5:5500)
        const baseUrl =
          window.location.origin +
          window.location.pathname.replace("restaurant-list.html", "");
        const link = `${baseUrl}menu.html?id=${id}`;

        document.getElementById("qrLinkDisplay").textContent = link;

        // Vẽ QR Code
        new QRCode(qrContainer, {
          text: link,
          width: 200,
          height: 200,
        });

        // Hiện Modal
        new bootstrap.Modal(document.getElementById("qrModal")).show();
      };
      // ----------------------------------
      // 5. UTILS & EVENTS
      const getFavs = () =>
        JSON.parse(localStorage.getItem("s2o_favorites") || "[]");
      const isFav = (id) => getFavs().includes(id);
      const toggleFav = (id) => {
        let favs = getFavs();
        if (favs.includes(id)) favs = favs.filter((i) => i !== id);
        else favs.push(id);
        localStorage.setItem("s2o_favorites", JSON.stringify(favs));
        return favs.includes(id);
      };

      const initTooltips = () =>
        [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map(
          (el) => new bootstrap.Tooltip(el),
        );
      const bindFavEvents = () => {
        document.querySelectorAll(".favorite-btn").forEach((btn) => {
          btn.onclick = function () {
            const active = toggleFav(parseInt(this.dataset.id));
            this.classList.toggle("active", active);
            this.innerHTML = `<i class="bi ${
              active ? "bi-heart-fill" : "bi-heart"
            }"></i>`;
            if (state.filter.favOnly) render();
          };
        });
      };

      const handleLocation = async () => {
        DOM.spinner.style.display = "flex";
        if (!navigator.geolocation) return alert("Trình duyệt không hỗ trợ!");
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const loc = {
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude,
            };
            state.filter.userLoc = loc;
            updateDistances(loc);
            DOM.prompt.style.display = "none";
            showToast("Đã cập nhật vị trí!", "success");
            render();
          },
          (err) => {
            console.error(err);
            showToast("Không lấy được vị trí.", "warning");
            DOM.spinner.style.display = "none";
          },
        );
      };

      const showToast = (msg, type) => {
        const div = document.createElement("div");
        div.className = `alert alert-${type} alert-dismissible fade show fixed-top m-3`;
        div.style.zIndex = 1050;
        div.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
      };

      // 6. INIT
      const init = async () => {
        // --- ĐOẠN CODE MỚI: CHẶN ADMIN ---
        const userStr = localStorage.getItem("user");
        if (userStr) {
          try {
            const u = JSON.parse(userStr);
            // Kiểm tra nếu là ADMIN hoặc SUPERADMIN
            if (
              u.role === "ADMIN" ||
              u.role === "SUPERADMIN" ||
              u.roles?.includes("ADMIN")
            ) {
              alert(
                "Tài khoản Quản trị viên không được truy cập trang đặt hàng!",
              );
              window.location.href = "admin.html"; // Chuyển hướng về trang Admin
              return; // Dừng chạy code phía dưới
            }
          } catch (e) {
            console.error("Lỗi parse user", e);
          }
        }
        // ----------------------------------

        await loadData();
        render(); // Render lần đầu (-- km)

        // Events
        DOM.search.oninput = (e) => {
          state.filter.text = e.target.value;
          render();
        };
        DOM.pills.forEach((pill) => {
          pill.onclick = function () {
            DOM.pills.forEach((p) => p.classList.remove("active"));
            this.classList.add("active");
            state.filter.category = this.dataset.category;
            render();
          };
        });
        DOM.tabFav.onclick = function (e) {
          e.preventDefault();
          state.filter.favOnly = !state.filter.favOnly;
          DOM.navItems.forEach((n) => n.classList.remove("active"));
          this.classList.add("active");
          this.querySelector(".nav-icon").className = `bi ${
            state.filter.favOnly ? "bi-heart-fill" : "bi-heart"
          } nav-icon`;
          render();
        };
        DOM.btnLocation.onclick = handleLocation;

        // Auto check permission
        if (navigator.permissions) {
          navigator.permissions.query({ name: "geolocation" }).then((res) => {
            if (res.state === "granted") handleLocation();
            else if (res.state === "prompt") DOM.prompt.style.display = "flex";
          });
        }
      };

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
