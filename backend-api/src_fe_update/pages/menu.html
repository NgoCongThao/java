<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S2O Food - Menu & ƒê√°nh gi√°</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      :root {
        --primary: #e85d04;
        --dark: #1a1a1a;
        --gray: #6c757d;
        --light-bg: #f8f9fa;
        --radius: 12px;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--light-bg);
        padding-bottom: 100px;
      }

      /* HEADER & NAV */
      .restaurant-header {
        position: relative;
        height: 35vh;
        min-height: 250px;
        background-color: var(--dark);
        color: white;
        display: flex;
        align-items: flex-end;
      }
      .header-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        opacity: 0.6;
        mask-image: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 1),
          rgba(0, 0, 0, 0.3)
        );
      }
      .header-content {
        position: relative;
        z-index: 2;
        padding: 20px;
        width: 100%;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }
      .back-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: var(--dark);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: 0.2s;
      }

      .sticky-nav {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        padding: 10px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .nav-scroll {
        display: flex;
        overflow-x: auto;
        padding: 0 15px;
        gap: 10px;
        scrollbar-width: none;
      }
      .nav-scroll::-webkit-scrollbar {
        display: none;
      }
      .cat-btn {
        border: 1px solid #eee;
        background: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        color: var(--gray);
        white-space: nowrap;
        transition: 0.2s;
      }
      .cat-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      /* MENU ITEMS - ƒê√É S·ª¨A: ƒê·ªÉ n√∫t c·ªông th·∫≥ng h√†ng d∆∞·ªõi c√πng */
      .menu-section {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px 15px;
      }
      .cat-title {
        font-weight: 800;
        font-size: 1.2rem;
        margin: 20px 0 15px;
        color: var(--dark);
        border-left: 4px solid var(--primary);
        padding-left: 10px;
      }
      .item-card {
        background: white;
        border-radius: var(--radius);
        padding: 12px;
        margin-bottom: 15px;
        display: flex;
        gap: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        cursor: pointer;
        transition: 0.2s;
        align-items: flex-start;
        min-height: 130px;
      }
      .item-img {
        width: 110px;
        height: 110px;
        border-radius: var(--radius);
        object-fit: cover;
        flex-shrink: 0;
        background: #eee;
      }
      .item-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 110px;
      }
      .item-name {
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 4px;
      }
      .item-price {
        color: var(--primary);
        font-weight: 700;
        font-size: 1.1rem;
        margin-top: auto;
      }
      .item-add-btn {
        display: flex;
        align-items: flex-end;
        color: var(--primary);
        padding-bottom: 5px;
      }

      /* MODAL & REVIEWS */
      .modal-content {
        border: none;
        border-radius: 20px;
        overflow: hidden;
      }
      .modal-img-wrapper {
        position: relative;
        height: 280px;
        background: #eee;
      }
      .modal-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0, 0, 0, 0.3);
        border: none;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .review-card {
        border-bottom: 1px solid #eee;
        padding: 15px 0;
      }
      .review-avatar {
        width: 40px;
        height: 40px;
        background: #e9ecef;
        color: #555;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
      }
      .star-rating i {
        font-size: 1.5rem;
        color: #dee2e6;
        cursor: pointer;
        transition: 0.2s;
        margin-right: 5px;
      }
      .star-rating i.active {
        color: #ffc107;
      }
      .star-display {
        color: #ffc107;
        font-size: 0.9rem;
      }

      /* CART & OFFCANVAS */
      .cart-bar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(150%);
        width: 90%;
        max-width: 600px;
        background: var(--dark);
        color: white;
        padding: 15px 25px;
        border-radius: 50px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 990;
        transition: 0.4s;
      }
      .cart-bar.show {
        transform: translateX(-50%) translateY(0);
      }
      .offcanvas-bottom {
        height: 85vh !important;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }
      .cart-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
      }
      .cart-item-img {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        object-fit: cover;
        margin-right: 10px;
      }
      .qty-mini-control {
        display: flex;
        align-items: center;
        background: #f1f1f1;
        border-radius: 20px;
        padding: 2px 8px;
      }
      .qty-mini-btn {
        border: none;
        background: none;
        color: var(--primary);
        font-weight: bold;
        width: 25px;
      }

      /* UTILS */
      .loading {
        text-align: center;
        padding: 50px;
        color: var(--gray);
      }
      .btn-add-cart {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 30px;
        font-weight: 700;
        flex: 1;
        margin-left: 15px;
      }
      .qty-control {
        display: flex;
        align-items: center;
        gap: 15px;
        background: #f1f1f1;
        border-radius: 30px;
        padding: 5px 15px;
      }
      .qty-btn {
        border: none;
        background: none;
        font-size: 1.5rem;
        color: var(--primary);
      }

      /* BOOKING MODAL TABLE GRID - ƒê√É S·ª¨A: Ch·ªâ 3 m√†u */
      .table-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        margin-top: 15px;
      }
      .table-item {
        aspect-ratio: 1;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 3px solid transparent;
        font-size: 0.9rem;
      }
      .table-item:hover {
        transform: scale(1.05);
      }
      .table-item.available {
        background-color: #28a745;
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
      }
      .table-item.booked {
        background-color: #dc3545;
        cursor: not-allowed;
        opacity: 0.7;
      }
      .table-item.selected {
        background-color: var(--primary);
        border-color: #ffba08;
        box-shadow: 0 0 0 4px rgba(232, 93, 4, 0.3);
      }
      .table-status-legend {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
        flex-wrap: wrap;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
      }
      .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 4px;
      }
      .cart-summary-alert {
        background: #e7f5ff;
        border-left: 4px solid #0d6efd;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
      }
      .table-loading {
        grid-column: 1 / -1;
        text-align: center;
        padding: 20px;
        color: var(--gray);
      }
    </style>
  </head>
  <body>
    <header class="restaurant-header">
      <div id="headerBg" class="header-bg"></div>
      <button
        class="back-btn"
        onclick="window.location.href = 'restaurant-list.html'"
      >
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="header-content container">
        <h1 id="resName" class="mb-1">ƒêang t·∫£i...</h1>
        <div class="d-flex align-items-center gap-3 font-sm">
          <span
            ><i class="fas fa-star text-warning"></i>
            <span id="resRating">--</span></span
          >
          <span><i class="fas fa-clock"></i> <span id="resTime">--</span></span>
          <span
            ><i class="fas fa-map-marker-alt"></i>
            <span id="resAddr">--</span></span
          >
        </div>
        <button
          class="btn btn-light text-primary fw-bold rounded-pill mt-3 px-4 shadow-sm"
          onclick="openBookingModal()"
        >
          <i class="fas fa-calendar-check me-2"></i> ƒê·∫∑t b√†n ngay
        </button>
      </div>
    </header>

    <div class="sticky-nav">
      <div class="nav-scroll" id="catNav"></div>
    </div>

    <main id="menuContainer" class="menu-section">
      <div class="loading">
        <div class="spinner-border text-warning"></div>
        <br />ƒêang t·∫£i th·ª±c ƒë∆°n...
      </div>
    </main>

    <div id="cartBar" class="cart-bar">
      <div>
        <div class="small opacity-75">T·ªïng c·ªông</div>
        <div class="fw-bold fs-5" id="floatTotal">0ƒë</div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <span class="badge bg-danger rounded-pill" id="floatCount">0</span>
        <button
          class="btn btn-light rounded-pill fw-bold text-dark px-3 py-1"
          data-bs-toggle="offcanvas"
          data-bs-target="#cartOffcanvas"
        >
          Xem gi·ªè
        </button>
      </div>
    </div>

    <div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-img-wrapper">
            <img id="modalImg" src="" class="modal-img" />
            <button
              type="button"
              class="modal-close-btn"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="modal-body p-4">
            <h2 id="modalName" class="fw-bold mb-1">T√™n m√≥n</h2>
            <div id="modalPrice" class="text-primary fw-bold fs-4 mb-3">0ƒë</div>

            <ul class="nav nav-tabs mb-3">
              <li class="nav-item">
                <button
                  class="nav-link active"
                  data-bs-toggle="tab"
                  data-bs-target="#info-tab"
                >
                  Th√¥ng tin
                </button>
              </li>
              <li class="nav-item">
                <button
                  class="nav-link"
                  data-bs-toggle="tab"
                  data-bs-target="#review-tab"
                >
                  ƒê√°nh gi√°
                </button>
              </li>
            </ul>

            <div class="tab-content">
              <div class="tab-pane fade show active" id="info-tab">
                <p id="modalDesc" class="text-muted">M√¥ t·∫£ m√≥n ƒÉn...</p>
              </div>

              <div class="tab-pane fade" id="review-tab">
                <div
                  id="reviewsList"
                  style="
                    max-height: 250px;
                    overflow-y: auto;
                    padding-right: 5px;
                  "
                >
                  <div class="text-center text-muted py-3">
                    ƒêang t·∫£i ƒë√°nh gi√°...
                  </div>
                </div>

                <div class="mt-3 pt-3 border-top bg-light p-3 rounded">
                  <h6 class="fw-bold mb-2">Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h6>
                  <div class="star-rating mb-2" id="starSelect">
                    <i class="fas fa-star active" onclick="setRating(1)"></i>
                    <i class="fas fa-star active" onclick="setRating(2)"></i>
                    <i class="fas fa-star active" onclick="setRating(3)"></i>
                    <i class="fas fa-star active" onclick="setRating(4)"></i>
                    <i class="fas fa-star active" onclick="setRating(5)"></i>
                    <span class="ms-2 text-warning fw-bold" id="ratingText"
                      >5.0 Tuy·ªát v·ªùi</span
                    >
                  </div>

                  <textarea
                    id="reviewInput"
                    class="form-control mb-2"
                    rows="2"
                    placeholder="Chia s·∫ª c·∫£m nh·∫≠n v·ªÅ m√≥n ƒÉn..."
                  ></textarea>
                  <div class="d-flex justify-content-end">
                    <button
                      class="btn btn-primary btn-sm px-4 rounded-pill"
                      onclick="submitReview()"
                    >
                      G·ª≠i ƒë√°nh gi√°
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            class="modal-footer d-flex justify-content-between align-items-center bg-white border-top p-3"
          >
            <div class="qty-control">
              <button class="qty-btn" onclick="updateModalQty(-1)">-</button>
              <span id="modalQty" class="qty-val">1</span>
              <button class="qty-btn" onclick="updateModalQty(1)">+</button>
            </div>
            <button class="btn-add-cart" onclick="addToCartFromModal()">
              Th√™m - <span id="modalBtnPrice">0ƒë</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="offcanvas offcanvas-bottom" tabindex="-1" id="cartOffcanvas">
      <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold">Gi·ªè h√†ng c·ªßa b·∫°n</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div id="cartListItems"></div>
        <div class="mb-3">
          <label class="form-label small fw-bold"
            ><i class="fas fa-comment-dots me-1"></i> Ghi ch√∫ cho qu√°n</label
          >
          <textarea
            id="orderNote"
            class="form-control"
            rows="2"
            placeholder="VD: √çt cay, kh√¥ng h√†nh, xin th√™m t∆∞∆°ng..."
          ></textarea>
        </div>
        <div class="bg-light p-3 rounded mt-3">
          <div class="input-group mb-2">
            <input
              type="text"
              id="voucherCode"
              class="form-control"
              placeholder="M√£ gi·∫£m gi√° (VD: SAVE10)"
            />
            <button class="btn btn-dark" onclick="applyVoucher()">
              √Åp d·ª•ng
            </button>
          </div>
          <div id="voucherMsg" class="small ms-1"></div>
        </div>

        <div class="p-3 border-top mt-3">
          <div class="d-flex justify-content-between mb-2">
            <span>T·∫°m t√≠nh</span><span id="cartSubtotal">0ƒë</span>
          </div>
          <div class="d-flex justify-content-between mb-2 text-success">
            <span>Gi·∫£m gi√°</span><span id="cartDiscount">0ƒë</span>
          </div>
          <div
            class="d-flex justify-content-between fw-bold fs-5 pt-2 border-top"
          >
            <span>T·ªïng thanh to√°n</span
            ><span id="cartFinalTotal" class="text-primary">0ƒë</span>
          </div>
          <div class="d-grid gap-2 mt-3">
            <button
              class="btn btn-primary py-3 rounded-pill fw-bold"
              onclick="checkout()"
            >
              <i class="fas fa-motorcycle"></i> GIAO NGAY / ƒÇN NGAY
            </button>
            <button
              class="btn btn-outline-primary py-2 rounded-pill fw-bold"
              onclick="openBookingWithCart()"
            >
              <i class="fas fa-calendar-alt"></i> ƒê·∫∂T B√ÄN K√àM M√ìN N√ÄY
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- BOOKING MODAL ƒê√É S·ª¨A: S·ª≠ d·ª•ng API th·ª±c t·∫ø -->
    <div class="modal fade" id="bookingModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 rounded-4">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">ƒê·∫∑t b√†n tr∆∞·ªõc</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body pt-2">
            <!-- Th√¥ng b√°o gi·ªè h√†ng -->
            <div id="cartSummaryAlert" class="cart-summary-alert d-none">
              <i class="fas fa-shopping-basket me-2"></i>
              <strong
                >B·∫°n ƒëang ƒë·∫∑t b√†n k√®m <span id="cartItemCount">0</span> m√≥n
                ƒÉn</strong
              >
            </div>

            <p class="text-muted small mb-4">
              Vui l√≤ng ƒëi·ªÅn th√¥ng tin v√† ch·ªçn b√†n ƒë·ªÉ gi·ªØ ch·ªó.
            </p>

            <form id="bookingForm">
              <div class="mb-3">
                <label class="form-label small fw-bold text-secondary"
                  >H·ªç v√† t√™n</label
                >
                <div class="input-group">
                  <span class="input-group-text bg-light border-0"
                    ><i class="fas fa-user text-muted"></i
                  ></span>
                  <input
                    type="text"
                    id="bookName"
                    class="form-control bg-light border-0"
                    required
                    placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n"
                  />
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label small fw-bold text-secondary"
                  >S·ªë ƒëi·ªán tho·∫°i</label
                >
                <div class="input-group">
                  <span class="input-group-text bg-light border-0"
                    ><i class="fas fa-phone text-muted"></i
                  ></span>
                  <input
                    type="tel"
                    id="bookPhone"
                    class="form-control bg-light border-0"
                    required
                    placeholder="09xxxxxxx"
                  />
                </div>
              </div>

              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="form-label small fw-bold text-secondary"
                    >Ng√†y ƒë·∫øn</label
                  >
                  <input
                    type="date"
                    id="bookDate"
                    class="form-control bg-light border-0"
                    required
                    onchange="loadTableStatus()"
                  />
                </div>
                <div class="col-6">
                  <label class="form-label small fw-bold text-secondary"
                    >Gi·ªù ƒë·∫øn</label
                  >
                  <input
                    type="time"
                    id="bookTime"
                    class="form-control bg-light border-0"
                    required
                    onchange="loadTableStatus()"
                  />
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label small fw-bold text-secondary"
                  >S·ªë l∆∞·ª£ng kh√°ch</label
                >
                <div
                  class="d-flex align-items-center bg-light rounded px-3 py-2"
                >
                  <i class="fas fa-users text-muted me-3"></i>
                  <input
                    type="range"
                    id="bookGuestsRange"
                    class="form-range flex-grow-1 me-3"
                    min="1"
                    max="20"
                    value="2"
                    oninput="
                      document.getElementById('guestCountDisplay').innerText =
                        this.value
                    "
                  />
                  <span id="guestCountDisplay" class="fw-bold text-primary fs-5"
                    >2</span
                  >
                </div>
              </div>

              <!-- PH·∫¶N CH·ªåN B√ÄN - S·ª¨ D·ª§NG API TH·ª∞C T·∫æ -->
              <div class="mb-4">
                <label
                  class="form-label small fw-bold text-secondary d-flex justify-content-between"
                >
                  <span>Ch·ªçn b√†n</span>
                  <span id="selectedTableInfo" class="text-primary fw-bold"
                    >Ch∆∞a ch·ªçn b√†n</span
                  >
                </label>

                <div class="bg-light p-3 rounded">
                  <div class="table-grid" id="tableGrid">
                    <!-- B√†n s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript t·ª´ API th·ª±c t·∫ø -->
                    <div class="table-loading">
                      <div class="spinner-border spinner-border-sm"></div>
                      <div class="mt-2">ƒêang t·∫£i danh s√°ch b√†n...</div>
                    </div>
                  </div>

                  <div class="table-status-legend mt-3">
                    <div class="legend-item">
                      <div
                        class="legend-color"
                        style="background-color: #28a745"
                      ></div>
                      <span>B√†n tr·ªëng</span>
                    </div>
                    <div class="legend-item">
                      <div
                        class="legend-color"
                        style="background-color: #dc3545"
                      ></div>
                      <span>ƒê√£ ƒë·∫∑t</span>
                    </div>
                    <div class="legend-item">
                      <div
                        class="legend-color"
                        style="background-color: var(--primary)"
                      ></div>
                      <span>ƒêang ch·ªçn</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mb-4">
                <label class="form-label small fw-bold text-secondary"
                  >Ghi ch√∫ (T√πy ch·ªçn)</label
                >
                <textarea
                  id="bookNote"
                  class="form-control bg-light border-0"
                  rows="2"
                  placeholder="VD: C·∫ßn gh·∫ø tr·∫ª em, ph√≤ng l·∫°nh, y√™u c·∫ßu ƒë·∫∑c bi·ªát..."
                ></textarea>
              </div>

              <button
                type="submit"
                class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-sm"
              >
                <i class="fas fa-calendar-check me-2"></i> X√°c nh·∫≠n ƒë·∫∑t b√†n
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script src="../js/chatbot.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // === 1. C·∫§U H√åNH & L·∫§Y THAM S·ªê URL ===
      const urlParams = new URLSearchParams(window.location.search);
      const REST_ID = urlParams.get("id");
      const TABLE_NUM = urlParams.get("table")
        ? parseInt(urlParams.get("table"))
        : 0;

      const CART_KEY = `s2o_cart_${REST_ID}`;
      const IMG_BACKUP = "../img/anhbackup.jpg";
      const VOUCHERS = { SAVE10: 0.1, FREESHIP: 15000 };

      // === 2. BI·∫æN M·ªöI CHO BOOKING ===
      let selectedTable = null;
      let bookingWithCart = false;

      // === 3. L·∫§Y USER T·ª™ LOCALSTORAGE ===
      let CURRENT_USER = null;
      const userStr = localStorage.getItem("user");

      if (userStr) {
        try {
          const u = JSON.parse(userStr);
          let avatarChar = "U";
          let fullName = u.fullName || u.username || "User";

          if (fullName) {
            const parts = fullName.trim().split(" ");
            if (parts.length > 0) {
              avatarChar = parts[parts.length - 1].charAt(0).toUpperCase();
            }
          }

          CURRENT_USER = {
            id: u.id,
            name: fullName,
            avatar: avatarChar,
          };
        } catch (e) {
          console.error("L·ªói parse user:", e);
          localStorage.removeItem("user");
        }
      }

      // === 4. KH·ªûI T·∫†O BI·∫æN TO√ÄN C·ª§C ===
      let cart = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
      let currentItem = null;
      let modalQty = 1;
      let userRating = 5;
      let appliedVoucher = null;

      // === 5. H√ÄM INIT (CH·∫†Y KHI LOAD TRANG) ===
      async function init() {
        if (!REST_ID) return alert("L·ªói: Thi·∫øu ID nh√† h√†ng");

        renderCartOffcanvas();

        try {
          // A. L·∫•y th√¥ng tin nh√† h√†ng
          const resRest = await fetch(
            `http://localhost:8080/api/guest/restaurants`,
          );
          const restaurants = await resRest.json();
          const info = restaurants.find((r) => r.id == REST_ID);

          if (info) {
            document.getElementById("resName").textContent = info.name;
            document.getElementById("resAddr").textContent = info.address;
            document.getElementById("resTime").textContent =
              info.time || "ƒêang c·∫≠p nh·∫≠t";
            document.getElementById("resRating").textContent = info.rating;

            const bg = new Image();
            bg.src = info.image;
            bg.onload = () =>
              (document.getElementById("headerBg").style.backgroundImage =
                `url('${info.image}')`);
            bg.onerror = () =>
              (document.getElementById("headerBg").style.backgroundImage =
                `url('${IMG_BACKUP}')`);
          }

          // B. L·∫•y Menu
          const resMenu = await fetch(
            `http://localhost:8080/api/guest/menu/restaurant/${REST_ID}`,
          );
          const flatItems = await resMenu.json();

          if (flatItems && flatItems.length > 0) {
            const groupedMenu = groupItemsByCategory(flatItems);
            renderMenu(groupedMenu);
          } else {
            document.getElementById("menuContainer").innerHTML =
              '<div class="text-center mt-5 text-muted"><i class="fas fa-utensils fa-3x mb-3"></i><br>Ch∆∞a c√≥ m√≥n ƒÉn n√†o</div>';
          }
        } catch (e) {
          console.error("L·ªói API:", e);
          document.getElementById("menuContainer").innerHTML =
            `<div class="alert alert-danger text-center">Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Server!</div>`;
        }
      }

      function groupItemsByCategory(items) {
        const groups = {};
        items.forEach((item) => {
          const catName = item.category || "M√≥n Kh√°c";
          if (!groups[catName]) groups[catName] = [];
          groups[catName].push(item);
        });
        return Object.keys(groups).map((key) => ({
          category: key,
          items: groups[key],
        }));
      }

      // === 6. RENDER MENU UI (ƒê√É S·ª¨A: N√∫t c·ªông th·∫≥ng h√†ng) ===
      function renderMenu(categories) {
        const nav = document.getElementById("catNav");
        const container = document.getElementById("menuContainer");
        nav.innerHTML = "";
        container.innerHTML = "";

        categories.forEach((cat, idx) => {
          const btn = document.createElement("button");
          btn.className = `cat-btn ${idx === 0 ? "active" : ""}`;
          btn.textContent = cat.category;
          btn.onclick = () => {
            document
              .querySelectorAll(".cat-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            document
              .getElementById(`cat-${idx}`)
              .scrollIntoView({ behavior: "smooth", block: "start" });
          };
          nav.appendChild(btn);

          let html = `<div id="cat-${idx}"><div class="cat-title">${cat.category}</div>`;
          cat.items.forEach((item) => {
            html += `
              <div class="item-card" onclick='openModal(${JSON.stringify(item)})'>
                <img src="${item.imageUrl || item.image || IMG_BACKUP}" class="item-img" onerror="this.src='${IMG_BACKUP}'">
                <div class="item-info">
                  <div><div class="item-name">${item.name}</div><div class="small text-muted">${item.description || ""}</div></div>
                  <div class="item-price">${item.price.toLocaleString()}ƒë</div>
                </div>
                <div class="item-add-btn">
                  <i class="fas fa-plus-circle fa-2x"></i>
                </div>
              </div>`;
          });
          html += `</div>`;
          container.innerHTML += html;
        });
      }

      // === 7. LOGIC MODAL CHI TI·∫æT M√ìN ===
      function openModal(item) {
        currentItem = item;
        modalQty = 1;
        setRating(5);

        document.getElementById("modalName").textContent = item.name;
        document.getElementById("modalPrice").textContent =
          item.price.toLocaleString() + "ƒë";
        document.getElementById("modalDesc").textContent =
          item.description || "M√≥n ngon m·ªói ng√†y.";
        const imgSrc = item.imageUrl || item.image || IMG_BACKUP;
        document.getElementById("modalImg").src = imgSrc;
        document.getElementById("modalImg").onerror = function () {
          this.src = IMG_BACKUP;
        };

        document.getElementById("modalQty").textContent = 1;
        document.getElementById("modalBtnPrice").textContent =
          item.price.toLocaleString() + "ƒë";

        loadFakeReviews();
        new bootstrap.Modal(document.getElementById("itemModal")).show();
      }

      function updateModalQty(change) {
        if (modalQty + change > 0) {
          modalQty += change;
          document.getElementById("modalQty").textContent = modalQty;
          document.getElementById("modalBtnPrice").textContent =
            (currentItem.price * modalQty).toLocaleString() + "ƒë";
        }
      }

      function addToCartFromModal() {
        const exist = cart.find((i) => i.id === currentItem.id);
        if (exist) exist.qty += modalQty;
        else cart.push({ ...currentItem, qty: modalQty });
        saveCart();
        bootstrap.Modal.getInstance(
          document.getElementById("itemModal"),
        ).hide();
        new bootstrap.Offcanvas(
          document.getElementById("cartOffcanvas"),
        ).show();
      }

      // === 8. LOGIC ƒê√ÅNH GI√Å (REVIEW) ===
      function setRating(n) {
        userRating = n;
        const stars = document.querySelectorAll("#starSelect i");
        const labels = ["T·ªá", "K√©m", "B√¨nh th∆∞·ªùng", "T·ªët", "Tuy·ªát v·ªùi"];
        document.getElementById("ratingText").textContent =
          `${n}.0 ${labels[n - 1]}`;
        stars.forEach((star, index) => {
          if (index < n) star.classList.add("active");
          else star.classList.remove("active");
        });
      }

      async function loadFakeReviews() {
        const list = document.getElementById("reviewsList");
        list.innerHTML =
          '<div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div> ƒêang t·∫£i...</div>';
        try {
          const res = await fetch(
            `http://localhost:8080/api/reviews/${currentItem.id}`,
          );
          if (!res.ok) throw new Error("L·ªói t·∫£i review");
          const reviews = await res.json();

          if (!reviews || reviews.length === 0) {
            list.innerHTML =
              '<div class="text-center text-muted py-3">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</div>';
          } else {
            let html = "";
            reviews.forEach((r) => {
              html += `
                <div class="review-card">
                  <div class="d-flex justify-content-between mb-1">
                    <div class="d-flex align-items-center">
                      <div class="review-avatar">${r.avatar}</div>
                      <div><div class="fw-bold font-sm">${r.user}</div><div class="star-display">${"‚òÖ".repeat(r.rate)}${"‚òÜ".repeat(5 - r.rate)}</div></div>
                    </div>
                    <div class="small text-muted">${r.date}</div>
                  </div>
                  <p class="mb-0 small text-muted ps-5">${r.comment}</p>
                </div>`;
            });
            list.innerHTML = html;
          }
        } catch (err) {
          list.innerHTML =
            '<div class="text-center text-danger py-3">Kh√¥ng th·ªÉ t·∫£i ƒë√°nh gi√°.</div>';
        }
      }

      async function submitReview() {
        if (!CURRENT_USER) {
          if (
            confirm("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°. ƒêi t·ªõi trang ƒëƒÉng nh·∫≠p?")
          ) {
            localStorage.setItem("redirect_after_login", window.location.href);
            window.location.href = "authcus.html";
          }
          return;
        }
        const text = document.getElementById("reviewInput").value;
        if (!text.trim()) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");

        const btn = document.querySelector("#review-tab button.btn-primary");
        if (btn) {
          btn.innerHTML = "Sending...";
          btn.disabled = true;
        }

        try {
          const res = await fetch(`http://localhost:8080/api/reviews/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: CURRENT_USER.id,
              itemId: currentItem.id,
              rating: userRating,
              comment: text,
            }),
          });
          if (res.ok) {
            alert("ƒê√£ g·ª≠i ƒë√°nh gi√°!");
            document.getElementById("reviewInput").value = "";
            loadFakeReviews();
          } else {
            alert("L·ªói: " + (await res.text()));
          }
        } catch (err) {
          alert("L·ªói server!");
        } finally {
          if (btn) {
            btn.innerHTML = "G·ª≠i ƒë√°nh gi√°";
            btn.disabled = false;
          }
        }
      }

      // === 9. LOGIC GI·ªé H√ÄNG & THANH TO√ÅN ===
      function renderCartOffcanvas() {
        const list = document.getElementById("cartListItems");
        let subtotal = 0;

        if (cart.length === 0) {
          list.innerHTML =
            '<div class="text-center p-4 text-muted"><i class="fas fa-shopping-basket fa-3x mb-3"></i><br>Gi·ªè h√†ng tr·ªëng</div>';
          document.getElementById("cartBar").classList.remove("show");
        } else {
          let html = "";
          cart.forEach((item, idx) => {
            subtotal += item.price * item.qty;
            html += `
              <div class="cart-item">
                <div class="d-flex align-items-center">
                  <img src="${item.imageUrl || item.image || IMG_BACKUP}" class="cart-item-img" onerror="this.src='${IMG_BACKUP}'">
                  <div><div class="fw-bold">${item.name}</div><div class="text-primary fw-bold">${item.price.toLocaleString()}ƒë</div></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <div class="qty-mini-control">
                    <button class="qty-mini-btn" onclick="updateCartItem(${idx}, -1)">-</button>
                    <span>${item.qty}</span>
                    <button class="qty-mini-btn" onclick="updateCartItem(${idx}, 1)">+</button>
                  </div>
                  <button class="btn btn-sm text-danger" onclick="removeCartItem(${idx})"><i class="fas fa-trash"></i></button>
                </div>
              </div>`;
          });
          list.innerHTML = html;
          document.getElementById("cartBar").classList.add("show");
          document.getElementById("floatCount").textContent = cart.reduce(
            (s, i) => s + i.qty,
            0,
          );
          document.getElementById("floatTotal").textContent =
            subtotal.toLocaleString() + "ƒë";
        }

        let discount = 0;
        if (appliedVoucher) {
          discount =
            appliedVoucher.type === "percent"
              ? subtotal * appliedVoucher.val
              : appliedVoucher.val;
        }
        if (discount > subtotal) discount = subtotal;

        document.getElementById("cartSubtotal").textContent =
          subtotal.toLocaleString() + "ƒë";
        document.getElementById("cartDiscount").textContent =
          "-" + discount.toLocaleString() + "ƒë";
        document.getElementById("cartFinalTotal").textContent =
          (subtotal - discount).toLocaleString() + "ƒë";
      }

      function updateCartItem(idx, change) {
        cart[idx].qty += change;
        if (cart[idx].qty <= 0) cart.splice(idx, 1);
        saveCart();
      }
      function removeCartItem(idx) {
        cart.splice(idx, 1);
        saveCart();
      }
      function saveCart() {
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
        renderCartOffcanvas();
      }
      function applyVoucher() {
        const code = document
          .getElementById("voucherCode")
          .value.trim()
          .toUpperCase();
        if (VOUCHERS[code]) {
          const val = VOUCHERS[code];
          appliedVoucher = { code, val, type: val < 1 ? "percent" : "fixed" };
          document.getElementById("voucherMsg").textContent =
            `ƒê√£ √°p d·ª•ng: ${code}`;
          document.getElementById("voucherMsg").className =
            "small text-success";
        } else {
          appliedVoucher = null;
          document.getElementById("voucherMsg").textContent = "M√£ kh√¥ng h·ª£p l·ªá";
          document.getElementById("voucherMsg").className = "small text-danger";
        }
        renderCartOffcanvas();
      }

      async function checkout() {
        if (cart.length === 0) return;

        const token = localStorage.getItem("token");
        if (!token || !CURRENT_USER) {
          localStorage.setItem("redirect_after_login", window.location.href);
          if (confirm("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng. ƒêi t·ªõi trang ƒëƒÉng nh·∫≠p?"))
            window.location.href = "authcus.html";
          return;
        }

        const btn = document.querySelector(
          '#cartOffcanvas button[onclick="checkout()"]',
        );
        const oldText = btn.innerHTML;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...';
        btn.disabled = true;

        try {
          const noteInput = document.getElementById("orderNote");
          const noteText = noteInput ? noteInput.value : "";

          const rawTotal =
            document.getElementById("cartFinalTotal").textContent;
          const totalAmount = parseFloat(
            rawTotal.replace(/\./g, "").replace("ƒë", ""),
          );

          const orderPayload = {
            userId: CURRENT_USER.id,
            restaurantId: REST_ID, // <--- ƒê√É TH√äM D√íNG N√ÄY (QUAN TR·ªåNG)
            restaurantName: document.getElementById("resName").textContent,
            total: totalAmount,
            tableNumber: TABLE_NUM,
            note: noteText,
            address: TABLE_NUM > 0 ? `B√†n ${TABLE_NUM} (Qu√©t QR)` : "T·∫°i b√†n",
            items: cart.map((i) => ({
              name: i.name,
              qty: i.qty,
              price: i.price,
            })),
          };

          const res = await fetch(`http://localhost:8080/api/orders/create`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(orderPayload),
          });

          if (res.ok) {
            alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! Vui l√≤ng ch·ªù x√°c nh·∫≠n.");
            cart = [];
            saveCart();
            bootstrap.Offcanvas.getInstance(
              document.getElementById("cartOffcanvas"),
            ).hide();
            window.location.href = "tracking.html";
          } else {
            const txt = await res.text();
            if (res.status === 401 || res.status === 403) {
              alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n.");
              localStorage.removeItem("token");
              window.location.href = "authcus.html";
            } else {
              alert("L·ªói ƒë·∫∑t h√†ng: " + txt);
            }
          }
        } catch (err) {
          console.error(err);
          alert("L·ªói h·ªá th·ªëng: " + err.message);
        } finally {
          btn.innerHTML = oldText;
          btn.disabled = false;
        }
      }

      // === 10. LOGIC BOOKING N√ÇNG C·∫§P (S·ª¨ D·ª§NG API TH·ª∞C T·∫æ) ===
      function openBookingModal(withCart = false) {
        if (!CURRENT_USER) {
          if (confirm("ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t b√†n?")) {
            localStorage.setItem("redirect_after_login", window.location.href);
            window.location.href = "authcus.html";
          }
          return;
        }

        bookingWithCart = withCart;

        // Hi·ªÉn th·ªã th√¥ng b√°o gi·ªè h√†ng
        const cartSummaryAlert = document.getElementById("cartSummaryAlert");
        if (cart.length > 0) {
          const totalItems = cart.reduce((total, item) => total + item.qty, 0);
          document.getElementById("cartItemCount").textContent = totalItems;
          cartSummaryAlert.classList.remove("d-none");
        } else {
          cartSummaryAlert.classList.add("d-none");
        }

        // ƒêi·ªÅn th√¥ng tin m·∫∑c ƒë·ªãnh
        document.getElementById("bookName").value = CURRENT_USER.name || "";
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("bookDate").value = today;
        document.getElementById("bookDate").min = today;

        // ƒê·∫∑t gi·ªù m·∫∑c ƒë·ªãnh l√† 1 ti·∫øng sau
        const now = new Date();
        const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
        const timeString =
          oneHourLater.getHours().toString().padStart(2, "0") +
          ":" +
          oneHourLater.getMinutes().toString().padStart(2, "0");
        document.getElementById("bookTime").value = timeString;

        // Reset ch·ªçn b√†n
        selectedTable = null;
        document.getElementById("selectedTableInfo").textContent =
          "Ch∆∞a ch·ªçn b√†n";

        // T·∫£i tr·∫°ng th√°i b√†n t·ª´ API th·ª±c t·∫ø
        loadTableStatus();

        new bootstrap.Modal(document.getElementById("bookingModal")).show();
      }

      // H√†m t·∫£i tr·∫°ng th√°i b√†n t·ª´ API th·ª±c t·∫ø
      async function loadTableStatus() {
        const date = document.getElementById("bookDate").value;
        const time = document.getElementById("bookTime").value;

        if (!date || !time) {
          renderTables([]);
          return;
        }

        const tableGrid = document.getElementById("tableGrid");
        tableGrid.innerHTML = `
          <div class="table-loading">
            <div class="spinner-border spinner-border-sm"></div>
            <div class="mt-2">ƒêang t·∫£i tr·∫°ng th√°i b√†n...</div>
          </div>
        `;

        try {
          // G·ªçi API th·ª±c t·∫ø t·ª´ Backend
          const res = await fetch(
            `http://localhost:8080/api/bookings/table-status?restaurantId=${REST_ID}&date=${date}&time=${time}`,
          );

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          }

          const tables = await res.json();
          renderTables(tables);
        } catch (error) {
          console.error("L·ªói t·∫£i tr·∫°ng th√°i b√†n:", error);
          tableGrid.innerHTML = `
            <div class="table-loading text-danger">
              <i class="fas fa-exclamation-triangle"></i>
              <div class="mt-2">Kh√¥ng th·ªÉ t·∫£i tr·∫°ng th√°i b√†n</div>
              <small class="text-muted">${error.message}</small>
            </div>
          `;
        }
      }

      // H√†m render l∆∞·ªõi b√†n t·ª´ d·ªØ li·ªáu API th·ª±c t·∫ø
      function renderTables(tables) {
        const tableGrid = document.getElementById("tableGrid");

        if (!tables || tables.length === 0) {
          tableGrid.innerHTML = `
            <div class="table-loading">
              <i class="fas fa-table fa-2x mb-2"></i>
              <div>Kh√¥ng c√≥ d·ªØ li·ªáu b√†n</div>
            </div>
          `;
          return;
        }

        let html = "";
        tables.forEach((table) => {
          let className = "table-item";

          if (table.status === "booked") {
            className += " booked";
          } else {
            className += " available";
          }

          if (selectedTable === table.number) {
            className += " selected";
          }

          html += `
            <div class="${className}" 
                 onclick="${table.status === "available" ? `selectTable(${table.number})` : ""}"
                 title="B√†n ${table.number}">
              ${table.number}
            </div>
          `;
        });

        tableGrid.innerHTML = html;
      }

      // H√†m ch·ªçn b√†n
      function selectTable(tableNumber) {
        selectedTable = tableNumber;
        document.getElementById("selectedTableInfo").textContent =
          `ƒê√£ ch·ªçn: B√†n ${tableNumber}`;
        renderTables(tables); // L∆∞u √Ω: c·∫ßn c√≥ bi·∫øn tables to√†n c·ª•c, ho·∫∑c g·ªçi l·∫°i API
        // T·∫°m th·ªùi reload l·∫°i UI b·∫±ng c√°ch g·ªçi l·∫°i loadTableStatus
        loadTableStatus();
      }

      /// X·ª≠ l√Ω submit form ƒë·∫∑t b√†n
      document.getElementById("bookingForm").onsubmit = async function (e) {
        e.preventDefault();

        // Ki·ªÉm tra ch·ªçn b√†n
        if (!selectedTable) {
          alert("Vui l√≤ng ch·ªçn b√†n tr∆∞·ªõc khi ƒë·∫∑t!");
          return;
        }

        const btn = this.querySelector("button[type=submit]");
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> X·ª≠ l√Ω...';
        btn.disabled = true;

        try {
          // T·∫°o payload ƒë·∫∑t b√†n
          const bookingPayload = {
            restaurantId: REST_ID,
            userId: CURRENT_USER.id,
            customerName: document.getElementById("bookName").value,
            phone: document.getElementById("bookPhone").value,
            date: document.getElementById("bookDate").value,
            time: document.getElementById("bookTime").value + ":00",
            guests: parseInt(document.getElementById("bookGuestsRange").value),
            note: document.getElementById("bookNote").value,
            tableNumber: selectedTable,
            // N·∫øu c√≥ gi·ªè h√†ng v√† ƒë·∫∑t b√†n k√®m m√≥n, th√™m items
            items:
              bookingWithCart && cart.length > 0
                ? cart.map((i) => ({
                    name: i.name,
                    qty: i.qty,
                    price: i.price,
                  }))
                : [],
          };

          const token = localStorage.getItem("token");
          const headers = {
            "Content-Type": "application/json",
          };

          if (token) {
            headers["Authorization"] = `Bearer ${token}`;
          }

          const res = await fetch("http://localhost:8080/api/bookings/create", {
            method: "POST",
            headers: headers,
            body: JSON.stringify(bookingPayload),
          });

          const result = await res.json();

          if (res.ok && result.success) {
            alert("üéâ " + result.message + " M√£ ƒë∆°n: #" + result.id);

            // N·∫øu ƒë·∫∑t b√†n k√®m m√≥n, x√≥a gi·ªè h√†ng
            if (bookingWithCart && cart.length > 0) {
              cart = [];
              saveCart();
            }

            bootstrap.Modal.getInstance(
              document.getElementById("bookingModal"),
            ).hide();
            this.reset();

            // Chuy·ªÉn sang trang tracking
            setTimeout(() => {
              window.location.href = "tracking.html";
            }, 1500);
          } else {
            alert("L·ªói: " + (result.message || "ƒê·∫∑t b√†n th·∫•t b·∫°i"));
          }
        } catch (err) {
          console.error("L·ªói ƒë·∫∑t b√†n:", err);
          alert("L·ªói k·∫øt n·ªëi: " + err.message);
        } finally {
          btn.innerHTML = oldText;
          btn.disabled = false;
        }
      };

      // M·ªü modal ƒë·∫∑t b√†n k√®m m√≥n
      function openBookingWithCart() {
        if (cart.length === 0) {
          alert("Gi·ªè h√†ng tr·ªëng! H√£y th√™m m√≥n ƒÉn tr∆∞·ªõc khi ƒë·∫∑t b√†n.");
          return;
        }
        openBookingModal(true);
      }

      // Ch·∫°y kh·ªüi t·∫°o
      init();
    </script>
  </body>
</html>
