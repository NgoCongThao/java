<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S2O Food - Menu & ƒê√°nh gi√°</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      :root {
        --primary: #e85d04;
        --dark: #1a1a1a;
        --gray: #6c757d;
        --light-bg: #f8f9fa;
        --radius: 12px;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--light-bg);
        padding-bottom: 100px;
      }

      /* HEADER & NAV */
      .restaurant-header {
        position: relative;
        height: 35vh;
        min-height: 250px;
        background-color: var(--dark);
        color: white;
        display: flex;
        align-items: flex-end;
      }
      .header-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        opacity: 0.6;
        mask-image: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 1),
          rgba(0, 0, 0, 0.3)
        );
      }
      .header-content {
        position: relative;
        z-index: 2;
        padding: 20px;
        width: 100%;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }
      .back-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: var(--dark);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: 0.2s;
      }

      .sticky-nav {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        padding: 10px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .nav-scroll {
        display: flex;
        overflow-x: auto;
        padding: 0 15px;
        gap: 10px;
        scrollbar-width: none;
      }
      .nav-scroll::-webkit-scrollbar {
        display: none;
      }
      .cat-btn {
        border: 1px solid #eee;
        background: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        color: var(--gray);
        white-space: nowrap;
        transition: 0.2s;
      }
      .cat-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      /* MENU ITEMS */
      .menu-section {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px 15px;
      }
      .cat-title {
        font-weight: 800;
        font-size: 1.2rem;
        margin: 20px 0 15px;
        color: var(--dark);
        border-left: 4px solid var(--primary);
        padding-left: 10px;
      }
      .item-card {
        background: white;
        border-radius: var(--radius);
        padding: 12px;
        margin-bottom: 15px;
        display: flex;
        gap: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        cursor: pointer;
        transition: 0.2s;
      }
      .item-img {
        width: 110px;
        height: 110px;
        border-radius: var(--radius);
        object-fit: cover;
        flex-shrink: 0;
        background: #eee;
      }
      .item-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .item-name {
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 4px;
      }
      .item-price {
        color: var(--primary);
        font-weight: 700;
        font-size: 1.1rem;
      }

      /* MODAL & REVIEWS */
      .modal-content {
        border: none;
        border-radius: 20px;
        overflow: hidden;
      }
      .modal-img-wrapper {
        position: relative;
        height: 280px;
        background: #eee;
      }
      .modal-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0, 0, 0, 0.3);
        border: none;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .review-card {
        border-bottom: 1px solid #eee;
        padding: 15px 0;
      }
      .review-avatar {
        width: 40px;
        height: 40px;
        background: #e9ecef;
        color: #555;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
      }
      .star-rating i {
        font-size: 1.5rem;
        color: #dee2e6;
        cursor: pointer;
        transition: 0.2s;
        margin-right: 5px;
      }
      .star-rating i.active {
        color: #ffc107;
      }
      .star-display {
        color: #ffc107;
        font-size: 0.9rem;
      }

      /* CART & OFFCANVAS */
      .cart-bar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(150%);
        width: 90%;
        max-width: 600px;
        background: var(--dark);
        color: white;
        padding: 15px 25px;
        border-radius: 50px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 990;
        transition: 0.4s;
      }
      .cart-bar.show {
        transform: translateX(-50%) translateY(0);
      }
      .offcanvas-bottom {
        height: 85vh !important;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }
      .cart-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
      }
      .cart-item-img {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        object-fit: cover;
        margin-right: 10px;
      }
      .qty-mini-control {
        display: flex;
        align-items: center;
        background: #f1f1f1;
        border-radius: 20px;
        padding: 2px 8px;
      }
      .qty-mini-btn {
        border: none;
        background: none;
        color: var(--primary);
        font-weight: bold;
        width: 25px;
      }

      /* UTILS */
      .loading {
        text-align: center;
        padding: 50px;
        color: var(--gray);
      }
      .btn-add-cart {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 30px;
        font-weight: 700;
        flex: 1;
        margin-left: 15px;
      }
      .qty-control {
        display: flex;
        align-items: center;
        gap: 15px;
        background: #f1f1f1;
        border-radius: 30px;
        padding: 5px 15px;
      }
      .qty-btn {
        border: none;
        background: none;
        font-size: 1.5rem;
        color: var(--primary);
      }
    </style>
  </head>
  <body>
    <header class="restaurant-header">
      <div id="headerBg" class="header-bg"></div>
      <button
        class="back-btn"
        onclick="window.location.href='restaurant-list.html'"
      >
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="header-content container">
        <h1 id="resName" class="mb-1">ƒêang t·∫£i...</h1>
        <div class="d-flex align-items-center gap-3 font-sm">
          <span
            ><i class="fas fa-star text-warning"></i>
            <span id="resRating">--</span></span
          >
          <span><i class="fas fa-clock"></i> <span id="resTime">--</span></span>
          <span
            ><i class="fas fa-map-marker-alt"></i>
            <span id="resAddr">--</span></span
          >
        </div>
      </div>
    </header>

    <div class="sticky-nav">
      <div class="nav-scroll" id="catNav"></div>
    </div>

    <main id="menuContainer" class="menu-section">
      <div class="loading">
        <div class="spinner-border text-warning"></div>
        <br />ƒêang t·∫£i th·ª±c ƒë∆°n...
      </div>
    </main>

    <div id="cartBar" class="cart-bar">
      <div>
        <div class="small opacity-75">T·ªïng c·ªông</div>
        <div class="fw-bold fs-5" id="floatTotal">0ƒë</div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <span class="badge bg-danger rounded-pill" id="floatCount">0</span>
        <button
          class="btn btn-light rounded-pill fw-bold text-dark px-3 py-1"
          data-bs-toggle="offcanvas"
          data-bs-target="#cartOffcanvas"
        >
          Xem gi·ªè
        </button>
      </div>
    </div>

    <div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-img-wrapper">
            <img id="modalImg" src="" class="modal-img" />
            <button
              type="button"
              class="modal-close-btn"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="modal-body p-4">
            <h2 id="modalName" class="fw-bold mb-1">T√™n m√≥n</h2>
            <div id="modalPrice" class="text-primary fw-bold fs-4 mb-3">0ƒë</div>

            <ul class="nav nav-tabs mb-3">
              <li class="nav-item">
                <button
                  class="nav-link active"
                  data-bs-toggle="tab"
                  data-bs-target="#info-tab"
                >
                  Th√¥ng tin
                </button>
              </li>
              <li class="nav-item">
                <button
                  class="nav-link"
                  data-bs-toggle="tab"
                  data-bs-target="#review-tab"
                >
                  ƒê√°nh gi√°
                </button>
              </li>
            </ul>

            <div class="tab-content">
              <div class="tab-pane fade show active" id="info-tab">
                <p id="modalDesc" class="text-muted">M√¥ t·∫£ m√≥n ƒÉn...</p>
              </div>

              <div class="tab-pane fade" id="review-tab">
                <div
                  id="reviewsList"
                  style="
                    max-height: 250px;
                    overflow-y: auto;
                    padding-right: 5px;
                  "
                >
                  <div class="text-center text-muted py-3">
                    ƒêang t·∫£i ƒë√°nh gi√°...
                  </div>
                </div>

                <div class="mt-3 pt-3 border-top bg-light p-3 rounded">
                  <h6 class="fw-bold mb-2">Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h6>
                  <div class="star-rating mb-2" id="starSelect">
                    <i class="fas fa-star active" onclick="setRating(1)"></i>
                    <i class="fas fa-star active" onclick="setRating(2)"></i>
                    <i class="fas fa-star active" onclick="setRating(3)"></i>
                    <i class="fas fa-star active" onclick="setRating(4)"></i>
                    <i class="fas fa-star active" onclick="setRating(5)"></i>
                    <span class="ms-2 text-warning fw-bold" id="ratingText"
                      >5.0 Tuy·ªát v·ªùi</span
                    >
                  </div>

                  <textarea
                    id="reviewInput"
                    class="form-control mb-2"
                    rows="2"
                    placeholder="Chia s·∫ª c·∫£m nh·∫≠n v·ªÅ m√≥n ƒÉn..."
                  ></textarea>
                  <div class="d-flex justify-content-end">
                    <button
                      class="btn btn-primary btn-sm px-4 rounded-pill"
                      onclick="submitReview()"
                    >
                      G·ª≠i ƒë√°nh gi√°
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            class="modal-footer d-flex justify-content-between align-items-center bg-white border-top p-3"
          >
            <div class="qty-control">
              <button class="qty-btn" onclick="updateModalQty(-1)">-</button>
              <span id="modalQty" class="qty-val">1</span>
              <button class="qty-btn" onclick="updateModalQty(1)">+</button>
            </div>
            <button class="btn-add-cart" onclick="addToCartFromModal()">
              Th√™m - <span id="modalBtnPrice">0ƒë</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="offcanvas offcanvas-bottom" tabindex="-1" id="cartOffcanvas">
      <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold">Gi·ªè h√†ng c·ªßa b·∫°n</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div id="cartListItems"></div>

        <div class="bg-light p-3 rounded mt-3">
          <div class="input-group mb-2">
            <input
              type="text"
              id="voucherCode"
              class="form-control"
              placeholder="M√£ gi·∫£m gi√° (VD: SAVE10)"
            />
            <button class="btn btn-dark" onclick="applyVoucher()">
              √Åp d·ª•ng
            </button>
          </div>
          <div id="voucherMsg" class="small ms-1"></div>
        </div>

        <div class="p-3 border-top mt-3">
          <div class="d-flex justify-content-between mb-2">
            <span>T·∫°m t√≠nh</span><span id="cartSubtotal">0ƒë</span>
          </div>
          <div class="d-flex justify-content-between mb-2 text-success">
            <span>Gi·∫£m gi√°</span><span id="cartDiscount">0ƒë</span>
          </div>
          <div
            class="d-flex justify-content-between fw-bold fs-5 pt-2 border-top"
          >
            <span>T·ªïng thanh to√°n</span
            ><span id="cartFinalTotal" class="text-primary">0ƒë</span>
          </div>
          <button
            class="btn btn-primary w-100 py-3 rounded-pill fw-bold fs-5 mt-3"
            onclick="checkout()"
          >
            ƒê·∫∂T ƒê∆†N
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // === C·∫§U H√åNH & TR·∫†NG TH√ÅI ===
      const REST_ID = new URLSearchParams(window.location.search).get("id");
      const CART_KEY = `s2o_cart_${REST_ID}`;
      const IMG_BACKUP = "../img/anhbackup.jpg";
      const VOUCHERS = { SAVE10: 0.1, FREESHIP: 15000 };

      // Gi·∫£ l·∫≠p User ƒëang ƒëƒÉng nh·∫≠p
      const CURRENT_USER = { id: 101, name: "Minh Tu·∫•n", avatar: "MT" };

      let cart = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
      let currentItem = null;
      let modalQty = 1;
      let userRating = 5; // S·ªë sao user ƒëang ch·ªçn
      let appliedVoucher = null;

      // === 1. KH·ªûI T·∫†O ===
      async function init() {
        if (!REST_ID) return alert("L·ªói: Thi·∫øu ID nh√† h√†ng");
        renderCartOffcanvas();

        try {
          // === TH√äM API CALL T·ª™ FILE M·ªöI (START) ===
          // L·∫•y th√¥ng tin nh√† h√†ng t·ª´ API
          const resRest = await fetch(`http://localhost:8080/api/guest/restaurants`);
          const restaurants = await resRest.json();
          const info = restaurants.find((r) => r.id == REST_ID);

          if (info) {
            document.getElementById("resName").textContent = info.name;
            document.getElementById("resAddr").textContent = info.address;
            document.getElementById("resTime").textContent = info.time || "ƒêang c·∫≠p nh·∫≠t";
            document.getElementById("resRating").textContent = info.rating;
            const bg = new Image();
            bg.src = info.image;
            bg.onload = () =>
              (document.getElementById(
                "headerBg"
              ).style.backgroundImage = `url('${info.image}')`);
            bg.onerror = () =>
              (document.getElementById(
                "headerBg"
              ).style.backgroundImage = `url('${IMG_BACKUP}')`);
          }

          // L·∫•y Menu t·ª´ API
          const resMenu = await fetch(`http://localhost:8080/api/guest/menu/restaurant/${REST_ID}`);
          const flatItems = await resMenu.json();

          if (flatItems && flatItems.length > 0) {
            // Nh√≥m m√≥n theo category (gi·ªëng file M·ªöI)
            const groupedMenu = groupItemsByCategory(flatItems);
            renderMenu(groupedMenu);
          } else {
            document.getElementById("menuContainer").innerHTML =
              '<div class="text-center mt-5 text-muted"><i class="fas fa-utensils fa-3x mb-3"></i><br>Ch∆∞a c√≥ m√≥n ƒÉn n√†o</div>';
          }
          // === TH√äM API CALL T·ª™ FILE M·ªöI (END) ===

        } catch (e) {
          console.error("L·ªói API:", e);
          document.getElementById("menuContainer").innerHTML = `<div class="alert alert-danger text-center">Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Server!</div>`;
        }
      }

      // H√†m nh√≥m m√≥n theo category t·ª´ file M·ªöI
      function groupItemsByCategory(items) {
        const groups = {};
        items.forEach(item => {
            const catName = item.category || "M√≥n Kh√°c";
            if (!groups[catName]) groups[catName] = [];
            groups[catName].push(item);
        });
        return Object.keys(groups).map(key => ({ category: key, items: groups[key] }));
      }

      // === 2. RENDER MENU ===
      function renderMenu(categories) {
        const nav = document.getElementById("catNav");
        const container = document.getElementById("menuContainer");
        nav.innerHTML = "";
        container.innerHTML = "";

        categories.forEach((cat, idx) => {
          const btn = document.createElement("button");
          btn.className = `cat-btn ${idx === 0 ? "active" : ""}`;
          btn.textContent = cat.category;
          btn.onclick = () => {
            document
              .querySelectorAll(".cat-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            document
              .getElementById(`cat-${idx}`)
              .scrollIntoView({ behavior: "smooth", block: "start" });
          };
          nav.appendChild(btn);

          let html = `<div id="cat-${idx}"><div class="cat-title">${cat.category}</div>`;
          cat.items.forEach((item) => {
            html += `
              <div class="item-card" onclick='openModal(${JSON.stringify(
                item
              )})'>
                <img src="${
                  item.imageUrl || item.image || IMG_BACKUP
                }" class="item-img" onerror="this.onerror=null; this.src='${IMG_BACKUP}'">
                <div class="item-info">
                  <div><div class="item-name">${
                    item.name
                  }</div><div class="small text-muted">${
              item.description || ""
            }</div></div>
                  <div class="item-price mt-2">${item.price.toLocaleString()}ƒë</div>
                </div>
                <div class="align-self-end text-primary"><i class="fas fa-plus-circle fa-2x"></i></div>
              </div>`;
          });
          html += `</div>`;
          container.innerHTML += html;
        });
      }

      // === 3. MODAL LOGIC ===
      function openModal(item) {
        currentItem = item;
        modalQty = 1;
        setRating(5); // Reset rating v·ªÅ 5 sao

        document.getElementById("modalName").textContent = item.name;
        document.getElementById("modalPrice").textContent =
          item.price.toLocaleString() + "ƒë";
        document.getElementById("modalDesc").textContent =
          item.description || "M√≥n ngon m·ªói ng√†y.";
        const imgSrc = item.imageUrl || item.image || IMG_BACKUP;
        document.getElementById("modalImg").src = imgSrc;
        document.getElementById("modalImg").onerror = function () {
          this.src = IMG_BACKUP;
        };

        document.getElementById("modalQty").textContent = 1;
        document.getElementById("modalBtnPrice").textContent =
          item.price.toLocaleString() + "ƒë";

        // GI·∫¢ L·∫¨P G·ªåI API L·∫§Y REVIEW (GET /api/reviews?itemId=...)
        loadFakeReviews();

        new bootstrap.Modal(document.getElementById("itemModal")).show();
      }

      function updateModalQty(change) {
        if (modalQty + change > 0) {
          modalQty += change;
          document.getElementById("modalQty").textContent = modalQty;
          document.getElementById("modalBtnPrice").textContent =
            (currentItem.price * modalQty).toLocaleString() + "ƒë";
        }
      }

      function addToCartFromModal() {
        const exist = cart.find((i) => i.id === currentItem.id);
        if (exist) exist.qty += modalQty;
        else cart.push({ ...currentItem, qty: modalQty });
        saveCart();
        bootstrap.Modal.getInstance(
          document.getElementById("itemModal")
        ).hide();
        new bootstrap.Offcanvas(
          document.getElementById("cartOffcanvas")
        ).show();
      }

      // === 4. REVIEW SYSTEM (BACKEND READY) ===

      // H√†m hi·ªÉn th·ªã sao ƒë√°nh gi√° (Click Event)
      function setRating(n) {
        userRating = n;
        const stars = document.querySelectorAll("#starSelect i");
        const text = document.getElementById("ratingText");
        const labels = ["T·ªá", "K√©m", "B√¨nh th∆∞·ªùng", "T·ªët", "Tuy·ªát v·ªùi"];

        stars.forEach((star, index) => {
          if (index < n) star.classList.add("active");
          else star.classList.remove("active");
        });
        text.textContent = `${n}.0 ${labels[n - 1]}`;
      }

      // H√†m gi·∫£ l·∫≠p l·∫•y ƒë√°nh gi√° t·ª´ Server
      function loadFakeReviews() {
        // MOCK DATA (Thay th·∫ø b·∫±ng fetch API)
        const reviews = [
          {
            user: "Thanh H·∫±ng",
            avatar: "TH",
            rate: 5,
            comment: "M√≥n n√†y ngon xu·∫•t s·∫Øc!",
            date: "20/12/2025",
          },
          {
            user: "ƒê·ª©c Ph√∫c",
            avatar: "ƒêP",
            rate: 4,
            comment: "H∆°i cay x√≠u nh∆∞ng v·∫´n ok.",
            date: "21/12/2025",
          },
        ];
        renderReviewsList(reviews);
      }

      function renderReviewsList(reviews) {
        let html = "";
        reviews.forEach((r) => {
          html += `
            <div class="review-card">
              <div class="d-flex justify-content-between mb-1">
                <div class="d-flex align-items-center">
                  <div class="review-avatar">${r.avatar}</div>
                  <div>
                    <div class="fw-bold font-sm">${r.user}</div>
                    <div class="star-display">${"‚òÖ".repeat(r.rate)}${"‚òÜ".repeat(
            5 - r.rate
          )}</div>
                  </div>
                </div>
                <div class="small text-muted">${r.date}</div>
              </div>
              <p class="mb-0 small text-muted ps-5">${r.comment}</p>
            </div>
          `;
        });
        document.getElementById("reviewsList").innerHTML = html;
      }

      // H√†m G·ª≠i ƒê√°nh Gi√° (POST API)
      function submitReview() {
        const text = document.getElementById("reviewInput").value;
        if (!text) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung ƒë√°nh gi√°!");

        // 1. T·∫°o Data chu·∫©n Backend y√™u c·∫ßu
        const payload = {
          userId: CURRENT_USER.id,
          userName: CURRENT_USER.name,
          itemId: currentItem.id,
          rating: userRating,
          comment: text,
          createdAt: new Date().toISOString(),
        };

        // 2. Log ra console cho Backend Dev xem
        console.log("SENDING TO BACKEND (POST /api/reviews):", payload);

        // 3. UI Update (Gi·∫£ l·∫≠p th√†nh c√¥ng)
        const newReview = {
          user: CURRENT_USER.name,
          avatar: CURRENT_USER.avatar,
          rate: userRating,
          comment: text,
          date: "V·ª´a xong",
        };

        // Th√™m v√†o ƒë·∫ßu danh s√°ch (Optimistic UI)
        const currentHTML = document.getElementById("reviewsList").innerHTML;
        document.getElementById("reviewsList").innerHTML =
          `
            <div class="review-card bg-light border-start border-primary border-3">
              <div class="d-flex justify-content-between mb-1">
                <div class="d-flex align-items-center">
                  <div class="review-avatar bg-primary text-white">${
                    newReview.avatar
                  }</div>
                  <div><div class="fw-bold font-sm">${
                    newReview.user
                  }</div><div class="star-display">${"‚òÖ".repeat(
            newReview.rate
          )}</div></div>
                </div>
                <div class="small text-muted">V·ª´a xong</div>
              </div>
              <p class="mb-0 small text-muted ps-5">${newReview.comment}</p>
            </div>
        ` + currentHTML;

        alert("ƒê√°nh gi√° th√†nh c√¥ng!");
        document.getElementById("reviewInput").value = ""; // Reset form
      }

      // === 5. CART & VOUCHER LOGIC ===
      function renderCartOffcanvas() {
        const list = document.getElementById("cartListItems");
        let subtotal = 0;

        if (cart.length === 0) {
          list.innerHTML =
            '<div class="text-center p-4 text-muted"><i class="fas fa-shopping-basket fa-3x mb-3"></i><br>Gi·ªè h√†ng tr·ªëng</div>';
          document.getElementById("cartBar").classList.remove("show");
        } else {
          let html = "";
          cart.forEach((item, idx) => {
            subtotal += item.price * item.qty;
            html += `
              <div class="cart-item">
                <div class="d-flex align-items-center">
                  <img src="${
                    item.imageUrl || item.image || IMG_BACKUP
                  }" class="cart-item-img" onerror="this.src='${IMG_BACKUP}'">
                  <div><div class="fw-bold">${
                    item.name
                  }</div><div class="text-primary fw-bold">${item.price.toLocaleString()}ƒë</div></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <div class="qty-mini-control">
                    <button class="qty-mini-btn" onclick="updateCartItem(${idx}, -1)">-</button>
                    <span>${item.qty}</span>
                    <button class="qty-mini-btn" onclick="updateCartItem(${idx}, 1)">+</button>
                  </div>
                  <button class="btn btn-sm text-danger" onclick="removeCartItem(${idx})"><i class="fas fa-trash"></i></button>
                </div>
              </div>`;
          });
          list.innerHTML = html;
          document.getElementById("cartBar").classList.add("show");
          document.getElementById("floatCount").textContent = cart.reduce(
            (s, i) => s + i.qty,
            0
          );
          document.getElementById("floatTotal").textContent =
            subtotal.toLocaleString() + "ƒë";
        }

        // T√≠nh ti·ªÅn
        let discount = 0;
        if (appliedVoucher) {
          if (appliedVoucher.type === "percent")
            discount = subtotal * appliedVoucher.val;
          else discount = appliedVoucher.val;
        }
        if (discount > subtotal) discount = subtotal;

        document.getElementById("cartSubtotal").textContent =
          subtotal.toLocaleString() + "ƒë";
        document.getElementById("cartDiscount").textContent =
          "-" + discount.toLocaleString() + "ƒë";
        document.getElementById("cartFinalTotal").textContent =
          (subtotal - discount).toLocaleString() + "ƒë";
      }

      function updateCartItem(idx, change) {
        cart[idx].qty += change;
        if (cart[idx].qty <= 0) cart.splice(idx, 1);
        saveCart();
      }
      function removeCartItem(idx) {
        cart.splice(idx, 1);
        saveCart();
      }
      function saveCart() {
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
        renderCartOffcanvas();
      }

      function applyVoucher() {
        const code = document
          .getElementById("voucherCode")
          .value.trim()
          .toUpperCase();
        const msg = document.getElementById("voucherMsg");

        if (VOUCHERS[code]) {
          const val = VOUCHERS[code];
          appliedVoucher = { code, val, type: val < 1 ? "percent" : "fixed" };
          msg.className = "small text-success";
          msg.textContent = `ƒê√£ √°p d·ª•ng: ${code}`;
          renderCartOffcanvas();
        } else {
          appliedVoucher = null;
          msg.className = "small text-danger";
          msg.textContent = "M√£ kh√¥ng t·ªìn t·∫°i!";
          renderCartOffcanvas();
        }
      }

      async function checkout() {
        if (cart.length === 0) return;

        // === TH√äM API CHECKOUT T·ª™ FILE M·ªöI (START) ===
        // 1. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P
        const token = localStorage.getItem("token");
        const userStr = localStorage.getItem("user");

        if (!token || !userStr) {
            // L∆∞u l·∫°i trang hi·ªán t·∫°i ƒë·ªÉ login xong quay l·∫°i
            localStorage.setItem("redirect_after_login", window.location.href);
            
            if(confirm("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng. Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p?")) {
                window.location.href = "authcus.html";
            }
            return;
        }

        // 2. CHU·∫®N B·ªä D·ªÆ LI·ªÜU
        const user = JSON.parse(userStr);
        const btn = document.querySelector('#cartOffcanvas button[onclick="checkout()"]');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...';
        btn.disabled = true;

        // L·∫•y t·ªïng ti·ªÅn d·∫°ng s·ªë (x√≥a 'ƒë' v√† d·∫•u ch·∫•m)
        const rawTotal = document.getElementById("cartFinalTotal").textContent;
        const totalAmount = parseFloat(rawTotal.replace(/\./g, '').replace('ƒë', ''));

        const orderPayload = {
            userId: user.id || 0,
            restaurantName: document.getElementById("resName").textContent,
            total: totalAmount,
            address: "T·∫°i b√†n (Qu√©t QR)",
            items: cart.map(i => ({
                name: i.name,
                qty: i.qty,
                price: i.price
            }))
        };

        // 3. G·ªåI API ƒê·∫∂T H√ÄNG
        try {
            const res = await fetch(`http://localhost:8080/api/orders/create`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(orderPayload)
            });

            if (res.ok) {
                alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! Vui l√≤ng ch·ªù x√°c nh·∫≠n.");
                cart = [];
                saveCart();
                bootstrap.Offcanvas.getInstance(
                    document.getElementById("cartOffcanvas")
                ).hide();
                window.location.href = "tracking.html";
            } else {
                const txt = await res.text();
                if (res.status === 401 || res.status === 403) {
                    alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n.");
                    localStorage.removeItem("token");
                    window.location.href = "authcus.html";
                } else {
                    alert("L·ªói ƒë·∫∑t h√†ng: " + txt);
                }
            }
        } catch (err) {
            console.error(err);
            alert("L·ªói k·∫øt n·ªëi Server!");
        } finally {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
        // === TH√äM API CHECKOUT T·ª™ FILE M·ªöI (END) ===
      }

      init();
    </script>
  </body>
</html>